define("confluence-collaborative-editor-plugin/synchrony-handlers",["underscore","jquery","ajs","confluence/meta","confluence/analytics-support","confluence/legacy","confluence-editor/editor/page-editor-message","confluence-collaborative-editor-plugin/lib/SyncManager","confluence-collaborative-editor-plugin/synchrony-util","confluence-collaborative-editor-plugin/synchrony-content","confluence-collaborative-editor-plugin/synchrony-presence","confluence-collaborative-editor-plugin/util/location-provider","confluence-collaborative-editor-plugin/util/url-parser","confluence-collaborative-editor-plugin/util/editor-format-fixer"],function(J,y,u,b,e,f,g,D,c,h,G,j,v,i){var q;var t;var a;var w;var o;var C;var E;var p=[];function r(N,O,M,L){c.time("confluence.editor.synchrony.connect");o=N;a=O;t=M;E=L.pipe(null,function(P){o.destroy();t.onDisconnectedState();return K(P,"collaborative-editor-load-failure",true)});q=y("#syncRev");w=a.getBody();o.on("init",x).on("update",z).on("ack",A).on("connected",m).on("disconnected",k).on("error",H);C=new D(o,{DEBUG_MODE:true});h.bindPostPasteFix();h.readTitleFromRootElement(w);f.Editor.overrideBeforeSave(n);y("#content-title").keyup(h.writeTitleToRootElement)}function F(M,L){if(L.contributors){p=L.contributors;u.unbind(M,F)}}u.bind("editor-heartbeat",F);function x(L){q.val(L.rev.toString())}function A(L){q.val(L.rev.toString());u.trigger("synchrony.entity.ack",{pendingChanges:L.pending.length>0})}function k(){t.onDisconnectedState();u.log("Synchrony disconnected!")}function H(L){if(L.level==="fatal"){u.trigger("editor.error.message",{disablePublish:true})}}function m(L){c.timeEnd("confluence.editor.synchrony.connect");u.log("Synchrony connected.");G.appendTo(L.sid,o,p);t.onConnectedState(o);u.trigger("synchrony.connected");h.fixTinymceCaretContainer(w,a)}function K(M,L,N){return{origin:"synchrony",cause:M,messageKey:L,disablePublish:N}}function n(O){var N=5000;var P=y.Deferred();function M(){P.resolve(O)}function L(R){if(!R.pending.length){o.off("ack",L);q.val(R.rev.toString());M()}}var Q=!o.ackState().pending.length;if(Q){M()}else{o.on("ack",L);setTimeout(function(){o.off("ack",L);P.reject(K("timeout"))},N)}return y.when(P,E).promise()}function I(M){var L=c.getLatestRevisionWithAttr(M.revisions,"user");return L?L.meta.user:u.I18n.getText("anonymous.name")}function s(L){g.handleMessage("editor.synchrony.page-published",{type:"info",message:u.I18n.getText("editor.synchrony.publish-page.message",u.escapeHtml(L)),close:"auto"});u.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.publish"});u.trigger("editor-shared-drafts-published")}function l(){b.set("new-page",false);b.set("page-id",f.getContentId());b.set("draft-id","0");if(!f.Editor.isLimitedModeEnabled()){f.Editor.UI.setButtonState(true,y("#rte-button-discard"))}}function z(M){if(M.updateType==="remote"){q.val(M.revisions[M.revisions.length-1].rev.toString());if(c.hasRevisionTrigger(M.revisions,"reset")){g.handleMessage("editor.synchrony.revert-page",{type:"info",message:u.I18n.getText("editor.synchrony.revert-page.message",u.escapeHtml(I(M)))});b.set("has-collaborated",false);B();u.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.revert"});u.trigger("editor-shared-drafts-discarded");f.Editor.heartbeat()}if(c.hasRevisionTrigger(M.revisions,"publish")){if(h.isUnpublished()){l()}b.set("has-collaborated",false);B();s(I(M));f.Editor.heartbeat()}if(c.hasRevisionType(M.revisions,"external")){u.trigger("editor.external.change")}var L=c.getLatestRevisionWithAttr(M.revisions,"confVersion");if(L&&L.meta.confVersion){y('meta[name="page-version"]').attr("content",L.meta.confVersion);y('meta[name="ajs-page-version"]').attr("content",L.meta.confVersion);b.set("page-version",L.meta.confVersion)}}setTimeout(function(){if(M.updateType==="init"||M.updateType==="remote"){u.trigger("editor.remote.change");h.readTitleFromRootElement(w)}if(M.updateType=="init"){if(d(j.getLocation())){a.undoManager.ignore(function(){var N=i.fixStaleBaseUrl(w);if(N>0){e.publish("collab.edit.format.stale.fix.count",{staleformatfixed:N})}})}else{u.log("Request url does not match the configured base url. Not performing fixStaleBaseUrl().")}a.undoManager.ignore(function(){i.fixMentions(w)})}h.fixTinymceCaretContainer(w,a);if(M.updateType==="local"){if(!a.undoManager.hasUndo()){a.setDirty(false)}u.trigger("editor.local.change")}},0)}function B(){if(o.ackState().pending.length===0){a.setDirty(false)}}function d(L){var M=b.get("context-path");var O=v.parseUrl(b.get("base-url"));var N=v.parseUrl(L);var P=v.parseUrl(N.protocol+"://"+N.host+M);return J.isEqual(O,P)}return{handle:r}});