define("confluence-editor/tinymce3/plugins/autocomplete/autocomplete-control",["ajs","jquery","confluence/legacy","confluence-editor/tinymce3/plugins/autocomplete/autocomplete-settings","document"],function(c,h,s,z,A){var v=function(d,i){var f,a,j=z.log("Autocompleter.Control"),u=require("tinymce"),b={},p=d.selection,t=p.getRng(!0),q=t.startOffset,l=t.startContainer;a=l.nodeValue;var n=i.leadingChar,x=d.getDoc(),o=i.backWords||0,F=i.insertedFromMenu||!1,k=z.Settings[n||"["];f=!k||"undefined"===typeof k.preventStartNodes?
"div.code, a[href], img, pre":k.preventStartNodes;if(h("#autocomplete",x).length)return c.debug("init","Autocomplete already exists, returning null."),null;b.backWords=o;b.maxResults=i.maxResults||10;null==a&&(t.collapsed&&q&&l.childNodes[q-1])&&(l=l.childNodes[q-1],q=(a=l.nodeValue)&&a.length||0);var r="";if(null!=a)for(var r=(a+"").substring(0,q),m=l.previousSibling;m&&3===m.nodeType;)r=m.nodeValue+r,m=m.previousSibling;var m=[/([("'<\(\u201c\u2018]\[|[\ufeff\u200b\u2014\s\xa0].)$/,/(\([^!])$/,
/(\/\/)$/],g;if(g=!o)if(g=r){a:{r+=n;g=0;for(var G=m.length;g<G;g++)if(m[g].test(r)){m=!0;break a}m=!1}g=!m}if(g)return j("init","Cursor is in wrong word location to start autocomplete, returning null."),null;if(h(l).closest(f).length)return j("init","Cursor is in wrong node to start autocomplete, returning null."),null;s.PropertyPanel&&s.PropertyPanel.current&&(s.PropertyPanel.shouldCreate=!1,s.PropertyPanel.destroy());!n&&null==a&&(c.debug("init","No text available for suggestion, range is",t),
a="");b.getContainer=function(){return h("#autocomplete",x)};if(t.collapsed&&o&&a){f=l;a=q;m=function(b,e,c){!e.global&&(e=RegExp(e.source,"g"+"i".slice(0,e.ignoreCase)+"m".slice(0,e.multiLine)));c==null?c=b.length:c<0&&(c=0);for(var b=b.substring(0,c+1),c=-1,d=0,a;(a=e.exec(b))!=null;){c=a.index;e.lastIndex=++d}return c};for(r=0;r<o;r++){g=f.nodeValue.substring(0,a);for(a=m(g,/\s+/,a);-1==a;)if((g=f.previousSibling)&&3===g.nodeType)f=g,(g=g.nodeValue)&&(a=m(g,/\s+/,g.length));else{r=o;break}}a+=
1;u.isIE&&1==o?(o=p.getRng(),o.moveStart("character",a-q),o.select()):(o=p.getRng(!0),o.setStart(f,a),o.setEnd(l,q),p.setRng(o))}q=p&&p.getNode()&&p.getNode().classList.contains("placeholder-inline-tasks")?"":p.getContent({format:"text"}).replace("\n","");j("init","suggestionHtml",q);l=c("span").attr("id","autocomplete");i.classNames&&l.addClass(i.classNames);n&&l.append(c("span").attr("id","autocomplete-trigger").text(n));n=c("span").attr("id","autocomplete-search-text");n.text(c.Rte.HIDDEN_CHAR);
l.append(n);p.setNode(l[0]);var w=b.getContainer();b.previousSearchText="";b.settings=k;!1!==k.cache&&!k.cacheManager?k.cacheManager=new c.Confluence.localStorageCacheManager(k.ch):!1===k.cache&&!k.cacheManager&&(k.cacheManager={get:h.noop,put:h.noop});k=h("#autocomplete-search-text",b.getContainer());n=h(x.createElement("span")).text(q||c.Rte.HIDDEN_CHAR);k.empty().append(n);p.select(n[0],!0);p.collapse();var B=function(c,e){if(b.onBeforeKey&&!b.onBeforeKey(e,b.text())){u.dom.Event.cancel(e);j("before",
"blocked by onBeforeKey: "+e.keyCode);return false}},C=function(c,e){var a=p.getRng(true),d=b.getContainer(),f=a.startContainer,a=f.parentNode;f.nodeType===3&&(a=a.parentNode);var g=(f=a?a.parentNode:null)?f.parentNode:null,d=a!==d[0]&&f!==d[0]&&g!==d[0];if(e.keyCode===27||d){j("after","dying because of: "+(d?"outside search span":"escape pressed"));b.die()}else if(b.onAfterKey&&!b.onAfterKey(e,b.text())){u.dom.Event.cancel(e);j("after","blocked by onAfterKey: "+e.keyCode);return false}},D=function(c,
e){if(b.onKeyPress&&!b.onKeyPress(e,b.text())){u.dom.Event.cancel(e);j("press","blocked by onKeyPress: "+e.keyCode);return false}},E=function(c,e){if(b.getContainer()[0]!=e.target.parentNode){j("click","Clicked outside of autocomplete, closing.");b.die()}};d.onKeyDown.addToTop(B);d.onKeyUp.addToTop(C);d.onKeyPress.addToTop(D);d.onClick.addToTop(E);b.word="";i.keepAlias?j("init","No suggestion based on previous or selected text"):b.word=q;c.Rte.showElement(w[0]);k=u.DOM.getPos(w[0]);n=w.height();b.left=
k.x;b.top=k.y+n;b.text=function(a){var e=h("#autocomplete-search-text",b.getContainer());if(a!=null){e.html(a);return this}a=c.escapeEntities(e.text());return a.replace(c.Rte.HIDDEN_CHAR,"")};b.plainText=function(a){var e=h("#autocomplete-search-text",b.getContainer());if(a!=null){e.text(a);return this}a=e.text();return a.replace(c.Rte.HIDDEN_CHAR,"")};var y=function(a,c){var d=b.getContainer();return v.replaceWithTextAndGetRange(d,a,c)};b.replaceWithSelectedSearchText=function(){var a=b.text();j("replaceWithSelectedSearchText",
a);y(a,false);return a};b.die=function(a){if(b.dying)c.debug("die","Already dying, returning.");else{b.dying=true;if(s.PropertyPanel)s.PropertyPanel.shouldCreate=true;if(b.getContainer().length){j("die","Tearing down autocomplete, cleaning up autocompleter");a=(a||i.backWords||F?"":b.settings.ch)+b.text();t=y(a,true)}setTimeout(function(){j("die","Removing autocomplete-control keyboard listeners.");d.onKeyDown.remove(B);d.onKeyUp.remove(C);d.onClick.remove(E);d.onKeyPress.remove(D)},1);c.Rte.unbindScroll("autocomplete");
h(A).unbind("click.autocomplete-outside");this.onDeath&&this.onDeath()}};c.Rte.bindScroll("autocomplete",function(a){c.debug("scrolling:",a);if(c.Rte.isAnyPartShown(w))b.onScroll();else b.die()});h(A).bind("click.autocomplete-outside",function(a){var c=a.srcElement&&a.srcElement.id==="rte-insert-date";!h(a.target).closest("#autocomplete-dropdown, .aui-datepicker-dialog, .ui-datepicker-header").length&&!c&&b.die()});c.Rte.getEditor().onBeforeExecCommand.add(function(a,c){c=="mceConfSavePage"&&b.die()});
b.update=function(a){c.Rte.BookmarkManager.storeBookmark();y("",true);this.settings.update(this,a)};b.removeSpan=function(){b.getContainer().remove()};return b};v.removeOrphanedControl=function(){var d=h(c.Rte.getEditor().getDoc()),i=d.find("#autocomplete"),f;if(!i.length)return null;f=d.find("#autocomplete-trigger").text();d=d.find("#autocomplete-search-text").text();v.replaceWithTextAndGetRange(i,d,!1);return{leadingChar:f,content:d}};v.replaceWithTextAndGetRange=function(d,i,f){if(d.length){var i=
i||"",f=f||!i,a=c.Rte.getEditor(),j=d[0].parentNode,h=c.Rte.Content.getChildIndex(j,d[0]),b=f?1:0,f=a.selection.getRng(!0);f.setStart(j,h+b);f.setEnd(j,h+1);d.before(i||c.Rte.HIDDEN_CHAR).remove();a.selection.setRng(f);return f}c.log("replaceWithTextAndGetRange Error: attempting to replace a non-existent element")};return v});require("confluence/module-exporter").exportModuleAsGlobal("confluence-editor/tinymce3/plugins/autocomplete/autocomplete-control","Confluence.Editor.Autocompleter.Control");