define("confluence-quick-edit/quick-edit",["ajs","confluence/legacy","confluence/templates","confluence/meta","jquery","window","document","confluence-quick-edit/util","wrm"],function(e,t,r,n,o,i,a,d,c){"use strict";var l={enableShortcut:function(){o("#editPageLink").addClass("full-load")},disableShortcut:function(){o("#editPageLink").removeClass("full-load")}};function u(t){o(".quick-comment-prompt",t.$container).hide(),o(".quick-comment-body",t.$container).addClass("comment-body");var i,a,d,c,l,u,s=e.Confluence.EditorLoader.getPreloadContainer();t.content&&t.content.title&&(i=s,a=t.content.title,i.find("#content-title").val(a)),t.$form.append(s.children()),s.show(),o("#editor-precursor").hide(),o("#rte-savebar").find(".toolbar-split-left").hide(),"comment"===n.get("content-type")&&(o("#pluggable-status").hide(),c=r.Editor.Page.cancelButton({contentType:n.get("content-type"),sharedDraftsEnabled:n.getBoolean("shared-drafts")}),l=o("#rte-button-cancel"),(u=l.parent(".rte-toolbar-group-done")).length?(u.remove(),o("#rte-button-discard").remove()):l.remove(),o("#rte-savebar").find(".toolbar-split-right").append(c),d=r.Editor.Page.previewButton({}),o("#rte-button-ellipsis").parent().remove(),o("#rte-savebar").find(".toolbar-group-preview").empty().append(d))}function s(t){t.$container.find(".quick-comment-loading-container").hide(),t.$form.show(),t.$form.addClass("fadeIn");var r,n,o,i=t.content?t.content.editorContent:"";r=t.editor,n=i,o=t.replayBufferedKeys,n&&(e.debug("Initial Editor Content from quick edit: ",n),r.setContent(n),r.startContent=r.getContent({format:"raw",no_events:1}),r.undoManager.clear()),o()&&r.undoManager.add(),e.trigger("quickedit.success"),e.trigger("quickedit.visible"),e.trigger("add-bindings.keyboardshortcuts"),e.trigger("active.dynamic.rte")}var f=[];var m={loadingContentTimeout:4e3,register:function(e){f.push(e)},disableHandlers:function(){o.each(f,function(e,t){return t.disable()})},enableHandlers:function(){o.each(f,function(e,t){return t.enable()})},SaveBarBinder:{bind:function(e,r){e&&t.Editor.addSaveHandler(e),r&&t.Editor.addCancelHandler(r)}},activateEditor:function(t){function r(){var r,f=new o.Deferred;if("READ_ONLY"===n.get("access-mode"))return e.logError("activateEditor could not be initialised: Read-only mode is enabled"),f.reject("READ_ONLY");if(e.Rte&&e.Rte.getEditor())return e.debug("there is already an editor open"),f.reject("EDITOR_OPEN");if(!t.$container||!t.$form)return e.logError("activateEditor could not be initialised: bad arguments",t),f.reject("BAD_ARGS");r=e.Confluence.BlockAndBuffer.block(o(a)),t.preActivate&&t.preActivate(),l.disableShortcut();var g=t.timeoutResources||e.Confluence.EditorLoader.loadingTimeout,p=m.loadingContentTimeout;var v,b,y,E=d.timeoutDeferred;return o.when(E("resources",(y=new o.Deferred,e.Confluence.EditorLoader.load(function(){setTimeout(function(){y.resolve()},0)},function(){y.reject()}),y),g),E("fetch content",t.fetchContent||o.Deferred().resolve(),p),E("additional resources",t.additionalResources?(v=t.additionalResources,b=new o.Deferred,c.require(v).done(function(e){b.resolve(e)}).fail(function(e){b.reject(e)}),b):o.Deferred().resolve(),g)).done(function(i,a){var d={$container:t.$container,content:a,$form:t.$form,replayBufferedKeys:r};t.preInitialise&&t.preInitialise(d),u(d);var c=function(){var r;d.editor=e.Rte.getEditor(),s(d),t.postInitialise&&t.postInitialise(d),m.SaveBarBinder.bind(t.saveHandler,t.cancelHandler),e.trigger("rte-quick-edit-ready"),r=n.get("content-type"),!n.get("collaborative-content")||"page"!==r&&"blogpost"!==r||e.trigger("rte-collab-editor-loaded"),e.unbind("rte-ready",c),f.resolve()};e.bind("rte-ready",c),e.bind("rte-destroyed",t.postDeactivate||function(){}),e.Rte.BootstrapManager.initialise({plugins:t.plugins,toolbar:t.toolbar,excludePlugins:t.excludePlugins,isQuickEdit:!0,onInitialise:t.onInitialise}),o("#rte-toolbar, #comments-section .aui-button").attr("tabindex","0")}).fail(function(r,n){f.reject(r,n),e.logError("Error loading page quick edit. Falling back to normal edit URL..."),e.trigger("analytics",{name:"rte.quick-edit.activate-editor.failed"}),t.fallbackUrl&&(e.log("This parameter is deprecated. To be removed in the next major version (5.8 or 6.0). Please use the promise returned to bind custom action if the editor fails to load instead."),i.location=t.fallbackUrl)}),f.promise()}if(t.closeAnyExistingEditor&&e.Rte&&e.Rte.getEditor()){var f=new o.Deferred;return this.deactivateEditor().done(function(){r().done(function(){f.resolve()}).fail(function(e){f.reject(e)})}).fail(function(){e.debug("Could not deactivate current editor."),f.reject("Could not deactivate current editor.")}),f.promise()}return r()},deactivateEditor:function(){require("tinymce").majorVersion>=4?require("tinymce").execCommand("mceRemoveEditor",!0,"wysiwygTextarea"):require("tinymce").execCommand("mceRemoveControl",!0,"wysiwygTextarea"),t.Editor.UI.toggleSavebarBusy(!1);var r=e.Confluence.EditorLoader.getPreloadContainer().empty();return o(".editor-container").remove(),o("#editor-precursor").remove(),o("#anonymous-warning").remove(),o(".quick-comment-prompt").show(),o(".bottom-comment-panels").show(),o("#editor-notification-container").empty(),o(".action-reply-comment").removeAttr("reply-disabled"),l.enableShortcut(),t.Editor.removeAllSaveHandlers(),t.Editor.removeAllCancelHandlers(),e.Confluence.EditorLoader.getEditorPreloadMarkup().done(function(t){r.append(t),r.hide(),new e.Confluence.QuickEditCaptchaManager(r).refreshCaptcha(),e.trigger("rte-destroyed"),e.unbind("rte-destroyed")})}};return m}),require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/quick-edit","AJS.Confluence.QuickEdit");