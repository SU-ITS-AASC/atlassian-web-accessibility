define("confluence-editor/editor/page-editor-ui",["jquery","confluence/templates","ajs","confluence/meta","confluence/legacy","window","moment","document","confluence/api/constants","confluence-editor/editor/page-editor-message","confluence-editor/editor/page-editor-quit-dialog"],function(t,e,n,o,r,i,a,c,d,u,s){"use strict";return function(){var d,u,l={},g=function(t,e){e=e||l.buttons;for(var n=0;n<e.length;n++)p(t,e[n])},p=function(t,e){e&&(t?(e.removeAttr("aria-disabled"),e.removeAttr("disabled"),e.removeClass("disabled")):(e.attr("aria-disabled","true"),e.attr("disabled","disabled"),e.addClass("disabled")))},f=function(t){return t.length&&"true"!==t.attr("aria-disabled")},m=function(){return o.get("new-page")},b=function(){var t="";return m()||(t=n.I18n.getText("edit.name")+" - "),t};return l.spinner=t("#rte-spinner"),l.saveButton=(d="#rte-button-publish",u=e.Editor.Page.saveButton({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:m()}),t(d).replaceWith(u),t(d)),l.overwriteButton=t("#rte-button-overwrite"),l.editButton=t("#rte-button-edit"),l.previewButton=t("#rte-button-preview"),l.cancelButton=t("#rte-button-cancel"),l.versionCommentInput=t("#versionComment"),l.watchPageCheckbox=t("#watchPage"),l.watchPageToolbarGroup=t(".toolbar-group-watch-page"),l.buttons=[l.saveButton,l.overwriteButton,l.editButton,l.previewButton,l.cancelButton],n.bind("editor-shared-drafts-published",function(){var t=/\(.+\)/g.exec(l.saveButton.data("tooltip"))[0];l.saveButton.text(e.Editor.Page.saveButtonText({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:m()})).attr("title",e.Editor.Page.saveButtonTitle({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:m()})+t).tooltip({gravity:"s"})}),l.setButtonsState=g,l.setButtonState=p,l.isButtonEnabled=f,l.registerFormButton=function(t,e){l[t]=e,l.buttons.push(e)},l.postingDatePicker=null,l.isFormEnabled=function(){for(var t=0;t<l.buttons.length;t++)if(f(l.buttons[t]))return!0;return!1},l.toggleSavebarBusy=function(t){if(t){if(!l.isFormEnabled())return!1;l.spinner.addClass("aui-icon-wait"),g(!1)}else l.spinner.removeClass("aui-icon-wait"),g(!0);return!0},l.init=function(){function e(){t("#rte-ellipsis-menu").is(":visible")&&t("#rte-button-ellipsis").trigger("aui-button-invoke")}s.init(),r.Editor.addSaveHandler(function(t){l.isButtonEnabled(l.saveButton)?(l.toggleSavebarBusy(!0),n.trigger("confluence.editor.on.save")):(t.stopImmediatePropagation(),t.preventDefault())}),n.trigger("rte.init.ui"),r.Editor.isNewPage()&&t("#content-title").focus().select(),r.Editor.addCancelHandler(function(t){r.Editor.getNumConcurrentEditors()>1&&n.Confluence.Analytics.publish("rte.notification.concurrent-editing.cancel",{numEditors:r.Editor.getNumConcurrentEditors(),pageId:n.params.pageId,draftType:n.params.draftType}),s.process(t)}),"comment"===o.get("content-type")&&r.Editor.addSaveHandler(function(){if(n.Rte.Content.isEmpty())return n.Confluence.EditorNotification.notify("warning",n.I18n.getText("content.empty")),l.toggleSavebarBusy(!1),!1}),"comment"!==o.get("content-type")&&"template"!==o.get("content-type")||r.Editor.addCancelHandler(function(t){if(l.isFormEnabled()&&r.Editor.hasContentChanged()&&!r.Editor.isEmpty()){var e="comment"===o.get("content-type")?n.I18n.getText("unsaved.comment.lost"):n.I18n.getText("unsaved.template.lost");if(!i.confirm(e))return t.stopImmediatePropagation(),!1}}),l.versionCommentInput.on("keypress",function(t){13===t.keyCode&&s.process(t)}),r.Editor.addSaveHandler(function(){r.Editor.getNumConcurrentEditors()>1&&n.Confluence.Analytics.publish("rte.notification.concurrent-editing.save",{numEditors:r.Editor.getNumConcurrentEditors(),pageId:n.params.pageId,draftType:n.params.draftType})}),r.Editor.addSubmitHandler(function(t){return r.Editor.contentFormSubmit(t)}),this.currentEditMode=this.MODE_RICHTEXT,l.editButton.click(function(t){var e=require("tinymce");l.isFormEnabled()&&(r.Editor.changeMode(r.Editor.MODE_RICHTEXT),setTimeout(function(){n.Rte.getEditor().focus(),e.isGecko&&r.Editor.bookmark&&n.Rte.getEditor().selection.moveToBookmark(r.Editor.bookmark)},0),l.cancelButton.enable()),t.preventDefault()}),l.previewButton.click(function(t){var n=require("tinymce");l.isFormEnabled()&&r.Editor.currentEditMode!==r.Editor.MODE_PREVIEW&&(e(),g(!1),l.spinner.addClass("aui-icon-wait"),n.isGecko&&!r.Editor.bookmark&&(r.Editor.bookmark=n.activeEditor.selection.getBookmark()),r.Editor.changeMode(r.Editor.MODE_PREVIEW,{errorCallback:function(){g(!0),l.spinner.removeClass("aui-icon-wait")}}),"comment"===o.get("content-type")||"template"===o.get("content-type")?l.cancelButton.disable():l.cancelButton.enable()),t.preventDefault()}),t("#rte-button-labels").bind("updateLabel",function(){var e=+o.get("num-labels")||0,r=n.I18n.getText("editor.labels.zero");1===e?r=n.I18n.getText("editor.labels.singular",e):e>1&&(r=n.I18n.getText("editor.labels.plural",e)),t("#rte-button-labels").attr("data-tooltip",r).attr("aria-label",r)}),t("#draft-status-lozenge").length&&t("#draft-status-lozenge").tooltip();var d=t("#PostingDate");d.length&&(d.attr("max",a().format("YYYY-MM-DD")),l.postingDatePicker=d.datePicker({overrideBrowserDefault:!0}),l.postingDatePicker.hide()),t("#wysiwygTextarea_parent .mceProgress, #wysiwygTextarea_parent .mceBlocker").on("click",function(){n.Rte.getEditor().focus()}),t(i).bind("render-content-loaded",function(e,n){var o,a=t("#previewArea iframe");a.contents().find("body")[0]==n&&(r.Editor.previewFrameOnload(n,a),o=!0,[l.saveButton,l.overwriteButton,l.editButton,l.previewButton].forEach(function(t){p(o,t)}),a.focus(),i.focus(),t(c).trigger("iframeAppended",a))}),o.get("heartbeat")&&(r.Editor.heartbeat(),r.Editor.heartbeatType.normal(),n.bind("rte-destroyed",r.Editor.heartbeatType.cleanup)),n.bind("watchpage.pageoperation",function(){l.toggleWatchPage(!1)}),n.bind("unwatchpage.pageoperation",function(){l.toggleWatchPage(!0)}),o.get("new-page")&&"inlinecommentform"===o.get("form-name")&&(c.title=n.I18n.getText("edit.name")+c.title);var u=c.title;o.get("new-page")&&t.trim(t("input#content-title").val())&&(c.title=b()+t("input#content-title").val()+" - "+o.get("space-name")+" - "+o.get("site-title")),t("input#content-title").on("change input",function(){if("template"!==o.get("content-type")){var e=b();t.trim(this.value)?c.title=e+this.value+" - "+o.get("space-name")+" - "+o.get("site-title"):c.title=u}}),t("body",t("#wysiwygTextarea_ifr").contents()).click(e),n.trigger("init.rte-control")},l.toggleWatchPage=function(t){t&&"comment"===o.get("content-type")?(l.watchPageToolbarGroup.show(),l.watchPageCheckbox.length&&(l.watchPageCheckbox[0].checked=!1)):l.watchPageToolbarGroup.hide()},l}}),require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor-ui",function(t){var e=require("confluence/legacy");require("ajs").bind("init.rte",function(){var n=t();e.Editor.UI=n,n.init()})});