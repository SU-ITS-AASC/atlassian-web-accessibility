define("confluence-quick-edit/handlers/comment","ajs confluence/legacy jquery aui/flag confluence-quick-edit/util confluence-editor/editor/page-editor-message confluence/message-controller".split(" "),function(a,h,e,n,l,i,g){function m(a,c){var d=a.match(RegExp("[?&]"+c+"=(\\d+)"));return d&&d.length>1?parseInt(d[1]):0}e(function(){a.AppLinksInitialisationBinder=function(b){a.bind("init.rte",b)}});var f={timeout:8E3,showLoadingEditorErrorMessage:function(b){a.trigger("rte-quick-comment-loading-failed");
var c={};if(b==="READ_ONLY"){c.title=a.I18n.getText("read.only.mode.default.error.title");c.body=a.I18n.getText("read.only.mode.default.error.description")}else{c.title=a.I18n.getText("quick.comment.loading.error.message.title");c.body=a.I18n.getText("quick.comment.loading.error.message")}g.showError(c,g.Location.FLAG)},preInitialise:function(){a.Confluence.QuickEdit.QuickEditPage.disable();a.Meta.set("content-type","comment");a.Meta.set("draft-type","");a.params.contentType="comment";a.params.draftType=
"";a.Meta.set("use-inline-tasks","false");e("#editor-precursor").children().eq(0).hide();e("#pagelayout-menu").parent().hide();e("#page-layout-2-group").hide();e("#rte-button-tasklist").remove();e("#pluggable-status-container").remove();e("#rte-insert-tasklist").parent().remove()},postInitialise:function(b){a.Rte.editorFocus(b.editor)},delegatingSaveCommentHandler:function(a){return a.asyncRenderSafe?f.ajaxSaveCommentHandler(a):f.reloadPageSaveCommentHandler(a)},reloadPageSaveCommentHandler:function(a){var c=
l.getBaseUrl();c.addQueryParam("focusedCommentId",a.id);c.addQueryParam("refresh",+new Date);window.location.href=c.toString()+"#comment-"+a.id},ajaxSaveCommentHandler:function(b){var c={isDefault:true,path:a.Meta.get("static-resource-url-prefix")+"/images/icons/profilepics/default.png"};a.Meta.get("current-user-avatar-uri-reference")!==a.contextPath()+"/images/icons/profilepics/default.png"&&(c={isDefault:false,path:a.Meta.get("current-user-avatar-uri-reference")});var d=a.Meta.get("remote-user"),
e={userName:d===""?null:d,displayName:a.Meta.get("current-user-fullname"),profilePicture:c};f.cancelComment().done(function(){h.CommentDisplayManager.addOrUpdateComment(e,b,true,false);a.trigger("page.commentAddedOrUpdated",{commentId:b.id})})},cancelHandler:function(){if(a.Confluence.QuickEdit){a.Rte.Content.editorResetContentChanged();a.Confluence.QuickEdit.deactivateEditor()}},createCommenterParam:function(b,c,d){return{userName:c||a.Meta.get("remote-user")||null,displayName:d||a.Meta.get("user-display-name"),
profilePicture:{isDefault:b.hasClass("defaultLogo"),path:b.attr("src")}}},createSaveHandler:function(b,c){var d=l.generateUUID();return function(f){f.preventDefault();if(a.Rte.Content.isEmpty()){a.Confluence.EditorNotification.notify("warning",a.I18n.getText("content.empty"));h.Editor.UI.toggleSavebarBusy(false)}else{var j=f=0,k=a.Confluence.EditorLoader.getEditorForm();if(k.is("form")){j=k.attr("action");f=m(j,"parentId");j=m(j,"commentId")}var g=new a.Confluence.QuickEditCaptchaManager(k),k=function(a,
b){c(a,b);g.refreshCaptcha()},i=e("#watchPage").is(":checked");j>0?h.Editor.CommentManager.updateComment(h.getContentId(),j,a.Rte.Content.getHtml(),i,g.getCaptchaData(),b,k):h.Editor.CommentManager.saveComment(h.getContentId(),f,a.Rte.Content.getHtml(),i,d,g.getCaptchaData(),b,k)}}},saveCommentErrorHandler:function(b,c){h.Editor.UI.toggleSavebarBusy(false);var d;if(b&&b.search(/captcha/i)!==-1){d=a.I18n.getText("captcha.response.failed");i.closeMessages(["captcha-response-failed"]);i.handleMessage("captcha-response-failed",
{type:"error",message:d})}else{d=a.I18n.getText("quick.comment.saving.error.message");if(c)g.showError(g.parseError(c,d),g.Location.FLAG);else{i.closeMessages(["server-offline"]);i.handleMessage("server-offline",{type:"error",message:d})}}a.logError("Error saving comment",b)},cancelComment:function(){a.Rte.Content.editorResetContentChanged();return a.Confluence.QuickEdit.deactivateEditor()},proceedWithActivation:function(){var b=new e.Deferred,c=a.Rte&&a.Rte.getEditor();if(c)if(c.isDirty()&&!h.Editor.isEmpty())if(confirm(a.I18n.getText("unsaved.comment.lost")))b=
f.cancelComment();else return b.reject();else b=f.cancelComment();else b.resolve();return b}};return f});require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/handlers/comment","AJS.Confluence.QuickEdit.QuickComment");