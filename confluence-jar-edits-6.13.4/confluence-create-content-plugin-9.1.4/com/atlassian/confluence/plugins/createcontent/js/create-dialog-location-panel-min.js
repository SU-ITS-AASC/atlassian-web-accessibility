(function(a){Confluence.Dialogs=Confluence.Dialogs||{};Confluence.Dialogs.LocationPanel=function b(r){AJS.bind(Confluence.Dialogs.Events.ITEM_SELECTED,d);var q,m,t,p,l=r.openDialog;var i;var c=null;var j="com.atlassian.confluence.plugins.confluence-create-content-plugin:create-blog-post";function k(v,u){var w=t.find(".template-select-container");w.addClass("loading");a("#create-dialog").find(".wait-icon").spin("medium");u.requestWebItems(v).done(function(x){u.fillWebItemsInDialog(false);a("#create-dialog").find(".wait-icon").spinStop()}).fail(function(){Confluence.sessionFail&&Confluence.sessionFail()})}r.openDialog=function(w){var v;if(!w||!w.createDialog){v=l(w)}else{v=w.createDialog}if(w&&w.dialogBase){AJS.$.extend(v,w.dialogBase)}t=v.popup.element;if(w.errorMessage){v.setDialogError(w.errorMessage)}else{var x=t.find(".create-dialog-body").prepend(Confluence.Templates.Blueprints.createDialogLocationPanel({}));p=x.find("#create-dialog-parent-container");i=x.find(".space-select");var u=r.loadedSpaces;defaultSpace=u.promotedSpaces.spaces[0]||u.otherSpaces.spaces[0];n(u,t);if(!t.options.showStepOne){r.fillWebItemsInDialog(false)}if(!m){m=f(defaultSpace.id)}m.done(function(y){e(y,t)});t.find(".create-dialog-location-bar input.space-select").change(function(){var y=a(this).val();k(y,v);f(y).done(function(z){e(z,t)})});t.options.updateHeight&&v.updateHeight()}return v};r.getParentPageId=function(){return c};r.filterWebItems=function(u){if(t.options.location=="child-page"){return _.reject(u,function(v){return v.itemModuleCompleteKey==j})}return u};r.getSpaceKey=function h(){var u=i.val();return u||AJS.Meta.get("space-key")};function d(w,x){if(!p||!p.length){AJS.log("WARNING: refreshLocation should not be getting triggered - $locationDiv is not set");return}var v;if(x){if(x.config){v=x.config}else{if(x.item){v=x.item.data()}}}var z=v&&(v.itemModuleCompleteKey||v.templateId)||null,u=a("#page-restricted-container").length||a(".request-access-container").length;if(!x.noVisibleItem&&!u&&g(z,v.spaceKey)){var y=Confluence.Blueprint.Util.getParentPageLocation();p.find("span").text(y.parentPageTitle);p.show();c=y.parentPageId}else{p.hide();c=null}}function g(x,w){if(!x){return true}var v=AJS.Meta.get("space-key"),u=w||i.val();if(!v||(v!=u)){return false}if(!Confluence.Blueprint.Util.getParentPageLocation().parentPageTitle){return false}if(AJS.Meta.get("content-type")!="page"){return false}if(x=="com.atlassian.confluence.plugins.confluence-business-blueprints:sharelinks-blueprint-item"){return false}return(x!=j)}function s(w){var v=[];var x=w.promotedSpaces.spaces;if(x&&x.length){v.push({text:AJS.I18n.getText("create.content.plugin.promoted.spaces"),children:x})}var u=w.otherSpaces&&!w.otherSpaces.resultsTruncated&&w.otherSpaces.spaces;if(u&&u.length){v.push({text:AJS.I18n.getText("spaces.all"),children:u})}return v}function n(B,A){if(B.otherSpaces&&B.otherSpaces.resultsTruncated){var w=A.find(".space-select-control-container .description");w.removeClass("hidden");var x={gravity:"w",delayIn:500,delayOut:0,offset:5};w.find("a").tooltip(x).click(function(){return false})}i.auiSelect2({data:s(B),escapeMarkup:function(C){return C},width:"270px",containerCssClass:"select2-space-select",formatResult:function(C,D,E){D.attr("title",a("<div/>").html(C.text).text());return a.fn.select2.defaults.formatResult.apply(this,arguments)},openOnEnter:false});var v=i.data("select2");v.data(B.promotedSpaces.spaces[0]||B.otherSpaces.spaces[0]);var y=50;var u=v.opts.populateResults;v.opts.populateResults=function(C,D,E){var G=false;var F=D;if(D[1]&&D[1].children&&D[1].children.length>y){F=[];a(D).each2(function(){F.push(a.extend(true,{},this))});F[1].children=F[1].children.slice(0,y);F[1].children.push({text:AJS.I18n.getText("create.content.plugin.select.space.see.more")});G=true}u.call(v,C,F,E);G&&D[1].children.pop()};var z=A.find(".select2-space-select .select2-input");if(z.length&&"placeholder" in z[0]){z.attr("placeholder",AJS.I18n.getText("create.content.plugin.create-dialog.space.dropdown.filter.placeholder-text")+" ...")}}function f(u){return a.ajax({url:Confluence.getContextPath()+"/rest/create-dialog/1.0/spaces/adminCheck",dataType:"json",data:{spaceKey:u}})}var o=(AJS.Meta.get("confluence-flavour").toLowerCase()!="vanilla");function e(y,x){var u=y,A=x.find(".add-remove-customise-templates-trigger");if(!u&&o){A.remove();return}var z=Confluence.getContextPath(),w;if(u){z+="/pages/templates2/listpagetemplates.action?key="+i.val();w=AJS.I18n.getText("create.content.plugin.plugin.add.or.customize.templates")}else{z+="/plugins/servlet/upm/marketplace/featured?category=Blueprints";w=AJS.I18n.getText("create.content.plugin.plugin.find.more.content")}var v=Confluence.Templates.Blueprints.customiseTemplatesLink({linkUrl:z,linkText:w});if(A.length){A.replaceWith(v)}else{x.find(".dialog-button-panel:first").prepend(v)}}}}(AJS.$));