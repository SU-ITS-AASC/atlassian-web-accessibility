define("confluence-editor/editor/page-editor-quit-dialog",["jquery","confluence/templates","ajs","confluence/meta","confluence/legacy","window","document","confluence-editor/editor/page-editor-message","confluence/api/constants","underscore"],function(t,e,o,n,i,a,r,d,s,l){"use strict";var c,u,g,f={},p={DELETE:"delete",REVERT:"revert",PUBLISH:"publish",UPDATE:"update",SHOW_DIFF:"diff"},h=[],E=!1,y={},v=0,m=5;function b(t){t.stopPropagation(),t.preventDefault(),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.show-diff-clicked"}),f.showDiffButton.hide(),C(),f.hideDiffButton.show()}function D(t){t.stopPropagation(),t.preventDefault(),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.hide-diff-clicked"}),f.hideDiffButton.hide(),f.showDiffButton.show(),f.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium"),x(g)}function B(e){g=c?p.REVERT:p.DELETE,U(),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard"}),e.stopPropagation(),e.preventDefault(),i.Editor.UI.setButtonsState(!1,f.buttonsAll),function e(n,a){var r=o.contextPath();var s=c?r+"/rest/synchrony/1.0/content/"+n+"/changes/unpublished":r+"/rest/api/content/"+n+"?status=draft";c&&d.suppressMessage("editor.synchrony.revert-page");a=a||0;t.ajax({url:s,type:"DELETE",data:{draftId:n},contentType:"application/json",dataType:"json"}).done(function(){c&&d.handleMessage("collaborative-editor-discard-error",{type:"success",close:"auto",message:o.I18n.getText("editor.discard-to-published.success.message")}),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-success",data:{contentId:n}}),w()}).fail(function(t){if(409===t.status&&a<m)o.trigger("disable-draft-save"),e(n,a+1);else{var r=JSON.parse(t.responseText),s=o.I18n.getText("draft.saving.error.could.not.delete"),l=t.errors||o.I18n.getText("discard.draft.unknown.error");r.data&&r.data.errors&&r.data.errors[0]&&"content.delete.published"===r.data.errors[0].message.key&&(s=o.I18n.getText("discard.draft.page-published.error.title"),l=o.I18n.getText("discard.draft.page-published.error")),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-error",data:{contentId:n}}),o.trigger("enable-draft-save"),d.handleMessage("collaborative-editor-discard-error",{type:"error",title:c?o.I18n.getText("editor.discard-to-published.error.title"):s,message:c?o.I18n.getText("editor.discard-to-published.error.message"):l}),f.dialog.hide(),i.Editor.UI.setButtonsState(!0,f.buttonsAll)}})}(n.get("content-id"))}function w(){f.editorForm.append(e.Editor.Page.hiddenInputCancel()).submit()}function T(t){t&&(t.stopPropagation(),t.preventDefault()),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.keep-draft-clicked",data:{contributorCount:h.length+1}}),w()}function I(t){i.Editor.UI.setButtonsState(!1,f.buttonsAll),y.save(t),U()}function q(t){t.stopPropagation(),t.preventDefault(),g=null,o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.draft-status-indicator.click"}),F(function(){f.closeButton.show(),C()})}function k(t){t.stopPropagation(),t.preventDefault(),f.closeButton.show(),n.get("new-page")?x(p.DELETE):x(p.REVERT)}function P(t){t.stopPropagation(),t.preventDefault(),f.dialog.hide()}function C(){f.dialogEl.removeClass("aui-dialog2-medium").addClass("aui-dialog2-xlarge"),x(p.SHOW_DIFF),t.ajax({url:s.CONTEXT_PATH+"/rest/tinymce/1/content/"+n.get("page-id")+"/draft/diff",type:"GET"}).success(function(t){f.dialogContent.find(".wiki-content").html(t).children().first().hasClass("diff-context-placeholder")&&f.dialogContent.find("hr").hide()})}function x(o,i){function a(){return o===p.SHOW_DIFF&&(g===p.REVERT||g===p.DELETE)}o!==p.UPDATE&&o!==p.PUBLISH||(v=(new Date).getTime()/1e3);var r=o;a()&&(r=g),f.dialogHeader.html(e.Editor.Page.quitDialogHeader({dialogType:r,contentType:n.get("content-type"),newPage:n.get("new-page")})),f.dialogContent.html(e.Editor.Page.quitDialogContent({dialogType:o,contributors:h,contentType:n.get("content-type"),newDialog:null==g})),f.hideDiffButton=t("#qed-hide-diff-button").click(D),n.get("new-page")||(o!==p.SHOW_DIFF&&(g=o),f.showDiffButton=t("#qed-show-diff-button").click(b),f.showDiffButton.show(),f.buttonsAll.push(f.showDiffButton)),o===p.DELETE||o===p.REVERT||a()?(f.discardButton.show(),f.dialogEl.addClass("aui-dialog2-warning")):f.dialogEl.removeClass("aui-dialog2-warning"),f.closeButton.show(),f.dialogFooter.find("."+o).show(),f.dialog.show()}function S(){U(),o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.dialog-closed"}),f.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium"),i.Editor.UI.toggleSavebarBusy(!1),f.dialogFooter.find(".aui-button").hide(),f.dialogContent.empty()}function U(){var t=(new Date).getTime()/1e3-v;o.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog."+g+".displayed",data:{displayTimeInSeconds:t,contentId:n.get("content-id")}}),v=0}function H(t,e){e&&e.contributors&&(h=l.reject(e.contributors,function(t){return t.name===n.get("remote-user")}))}function F(e){i.Editor.Drafts.save({forceSave:c,skipErrorHandler:!0,onSuccessHandler:e||t.noop})}return{init:function(e){(u=n.getBoolean("shared-drafts")&&("page"===n.get("content-type")||"blogpost"===n.get("content-type")))&&(E?(y.save=e&&e.saveHandler,f.publishButton.click(I)):(c=!n.get("new-page"),f.discardButton=t("#qed-discard-button").prop("role","dialog").removeAttr("title").attr("aria-label","Quit Notice").tooltip({gravity:"s",className:"quit-editor-dialog"}),i.Editor.isLimitedModeEnabled()&&c?(i.Editor.UI.setButtonState(!1,f.discardButton),f.discardButton.removeAttr("disabled")):f.discardButton.click(B),f.saveExitButton=t("#qed-save-exit-button").click(T),f.hideDiffButton=t("#qed-hide-diff-button").click(D),f.publishButton=t("#qed-publish-button").removeAttr("title"),f.closeButton=t("#qed-close-button").click(P),f.buttonsAll=[f.discardButton,f.saveExitButton,f.showDiffButton,f.hideDiffButton,f.publishButton],f.dialog=o.dialog2("#quit-editor-dialog"),f.dialogEl=f.dialog.$el,f.dialogHeader=f.dialogEl.find(".aui-dialog2-header"),f.dialogContent=f.dialogEl.find(".aui-dialog2-content"),f.dialogFooter=f.dialogEl.find(".aui-dialog2-footer"),f.editorForm=t("#wysiwyg").closest("form"),t("#rte-show-changes").on("click",q),t("#rte-show-revert").on("click",k),n.get("new-page")||t("#pluggable-status").on("click","a",q),f.dialog.on("hide",S),o.bind("editor-heartbeat",H),E=!0))},process:function(e){u&&(e.stopPropagation(),e.preventDefault(),t(a).one("editor-heartbeat rte.heartbeat-error",function(t,o){switch(e.target.id){case i.Editor.UI.saveButton.attr("id"):case i.Editor.UI.versionCommentInput.attr("id"):!function(){if(i.Editor.UI.toggleSavebarBusy(!0),0===h.length)y.save();else{F();var t=c?p.UPDATE:p.PUBLISH;x(t)}}();break;case i.Editor.UI.cancelButton.attr("id"):i.Editor.Drafts.isDraftDirty()&&F(),T()}}),i.Editor.heartbeat())},_destroy:function(){E=!1}}});