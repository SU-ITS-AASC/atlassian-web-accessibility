define("confluence-editor/editor/page-editor","ajs confluence/legacy jquery document window confluence/meta confluence/api/constants confluence-editor/editor/page-editor-message".split(" "),function(c,d,b,k,N,f,m,l){function n(){var a=f.getBoolean("shared-drafts"),e=f.get("content-type")==="page"||f.get("content-type")==="blogpost",b=c.params.pageId!=="0";return e&&(b||a)}function B(a){b("#editpageform").find("input[name='atl_token']").val(a);f.set("atl-token",a);f.set("atlassian-token",a);b("#atlassian-token").attr("content",
a)}var u=c.DarkFeatures.isEnabled("editor.ajax.save")&&!c.DarkFeatures.isEnabled("editor.ajax.save.disable")&&f.get("remote-user")!=="",o=[],p=[],q=[],C=false,i=1,v=false,r,D=function(a){d.Editor.UI.setButtonState(a,d.Editor.UI.saveButton);d.Editor.UI.setButtonState(a,d.Editor.UI.previewButton);d.Editor.UI.setButtonState(a,d.Editor.UI.cancelButton)},s=function(a){var a=a||{},e=a.messageKey||"editor-error-message",b=a.message||c.I18n.getText("editor.generic.refresh");l.handleMessage(e,{title:a.title,
type:"error",message:b},function(){a.disablePublish&&D(false)})},E=function(){return f.get("edit-mode")==="limited"},P=function(a){var e=true;l.closeMessages(["offline-before-save-error"]);for(var b=0;b<p.length;b++){p[b](a)===false&&(e=false);if(a.isImmediatePropagationStopped())break}if(!e||a.isDefaultPrevented()||a.isPropagationStopped())return false;a.preventDefault();F(a).done(w).fail(O)},O=function(a){var e=a||{};s({messageKey:e.messageKey||"offline-before-save-error",message:e.disablePublish?
c.I18n.getText("editor.generic.refresh"):c.I18n.getText("editor.offline.before.save.error"),disablePublish:e.disablePublish});a&&c.trigger("analytics",{name:"editor.save.error."+a.origin+"."+a.cause});d.Editor.UI.toggleSavebarBusy(false);d.Editor.Drafts.bindUnloadMessage()},F=function(a){var e=b.Deferred();e.resolve(a);return e.promise()},G=function(){var a=function(){v=true;b(d.Editor.getCurrentForm()).submit();c.trigger("analytics",{name:"confluence.editor.close",data:{source:"publishButton"}})},
e=d.Editor.Drafts.getDraftSavingPromise();e?e.always(a):a()},w=G;c.bind("rte-ready",function(){c.Meta.getBoolean("collaborative-content")||b('meta[name="ajs-collaborative-editor-status"]').attr("content","off");d.Editor.UI.saveButton.bind("click",P)});c.bind("editor.error.message",function(a,e){s(e)});c.bind("dismiss.editor.error.message",function(a,e){l.closeMessages([e.messageKey]);e.enablePublish&&D(true)});var Q=function(){var a;for(a=0;a<o.length;a++)d.Editor.UI.cancelButton.click(o[a]);var e=
b(d.Editor.getCurrentForm());for(a=0;a<q.length;a++)e.submit(q[a]);b.unbind("init.rte",this)},H=function(a,e,d,j){j.push(d);if(c.Rte&&c.Rte.BootstrapManager&&c.Rte.BootstrapManager.isInitComplete())a.bind(e,d);else if(!C){C=true;b.bind("init.rte",Q)}},x=function(a,e,b){var d=null;c.Rte&&(c.Rte.BootstrapManager&&c.Rte.BootstrapManager.isInitComplete())&&(d=function(a,e,b){a.unbind(e,b)});for(var f=b.pop();f;){d&&d(a,e,f);f=b.pop()}},I=function(a){if(g!==a){g&&g.clear();a.start(d.Editor.heartbeat);
g=a}},g,J=f.getNumber("heartbeat-interval")||3E4,y,K;y={start:function(a){c.debug("Changing heartbeat to the normal scheduler");K=setInterval(a,J)},clear:function(){clearInterval(K)}};var L,M=Math.max(J/5,5E3),z,A;L={start:function(a){c.debug("Changing heartbeat to the recovery scheduler");A=0;var e=function(){a();var b=M*Math.pow(2,A);z=setTimeout(e,Math.min(b,3E5));A++};z=setTimeout(e,M)},clear:function(){clearTimeout(z)}};return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_PREVIEW:"preview",PREVIEW_OUTPUT_TYPE:"PREVIEW",
currentEditMode:null,contentHasChangedSinceLastSave:false,sourceInitialValue:false,isPublishing:function(a){typeof a!=="undefined"&&(v=a);return v},isLimitedModeEnabled:E,overrideBeforeSave:function(a){F=a},overrideSave:function(a){w=a},restoreDefaultSave:function(){w=G},getNumConcurrentEditors:function(){return i},addCancelHandler:function(a){H(d.Editor.UI.cancelButton,"click",a,o)},addSaveHandler:function(a){p.push(a)},addSubmitHandler:function(a){H(b(d.Editor.getCurrentForm()),"submit",a,q)},removeAllCancelHandlers:function(){x(d.Editor.UI.cancelButton,
"click",o)},removeAllSaveHandlers:function(){x(d.Editor.UI.saveButton,"click",p)},removeAllSubmitHandlers:function(){x(b(d.Editor.getCurrentForm()),"submit",q)},hasContentChanged:function(){return!this.inRichTextMode()&&!this.contentHasChangedSinceLastSave?false:this.editorHasContentChanged()},editorHasContentChanged:function(){if(c.Rte.getEditor()==null){c.debug("Confluence.Editor: editorHasContentChanged - No active editor present. Returning false.");return false}return c.Rte.Content.editorHasContentChanged()},
isEmpty:function(){var a=b(c.Rte.getEditor().getContent()).text();return!b.trim(a)},getResumeDraftUrl:function(){var a=[];a.push(m.CONTEXT_PATH);a.push("/pages/"+(c.params.newPage?"create":"edit")+c.params.draftType+".action");a.push("?useDraft=true");a.push("&pageId="+c.params.pageId);a.push("&contentChanged="+this.hasContentChanged());this.getCurrentForm().spaceKey&&a.push("&spaceKey="+f.get("space-key"));return a.join("")},getCurrentTitle:function(){return b("#content-title")&&b("#content-title").val()},
contentFormSubmit:function(){(E()||!d.Editor.Drafts.isSharedDraftsEnabled())&&d.Editor.Drafts.unBindUnloadMessage();b(".editable-title #content-title").prop("disabled",true);return true},metadataSyncRequired:n,heartbeat:function(){var a={dataType:"json",contentId:f.get("content-id"),draftType:f.get("content-type"),spaceKey:c.params.spaceKey,contributorsHash:f.get("contributors-hash")};r=c.safe.post(m.CONTEXT_PATH+"/json/startheartbeatactivity.action",a,function(a){if(!n()&&a){B(a.atlToken);c.Meta.set("shared-drafts",
a.editMode!=="legacy");c.trigger("rte.heartbeat",a)}else if(!a||!a.atlToken||!(a.activityResponses instanceof Array)){c.trigger("rte.heartbeat-error","Invalid server response");c.logError("Unexpected server response for heartbeat:");c.log(a)}else{f.set("contributors-hash",a.contributorsHash);c.Meta.set("shared-drafts",a.editMode!=="legacy");var h=a.activityResponses;B(a.atlToken);d.Editor.heartbeatType.normal();c.trigger("rte.heartbeat",h);i=(h.length||0)+1;if(i>1){var j=!u?b("#other-users-span"):
b("#reliable-other-users-span").length===0?b("<span id='reliable-other-users-span'></span>"):b("#reliable-other-users-span");j.empty();for(var t=0;t<i-1;++t){t>0&&j.append(", ");var g=h[t];j.append(c("a").attr("href",m.CONTEXT_PATH+"/display/~"+encodeURIComponent(g.userName)).text(g.fullName));g.lastEditMessage!=null&&j.append(" ").append(c("span").addClass("smalltext").text(g.lastEditMessage))}u&&!l.isDisplayed(["heartBeat"])&&j.html().trim()!==""&&l.handleMessage("heartBeat",{type:"info",message:c.I18n.getText("heartbeat.page.edited.info",
"<span id='reliable-other-users-span'>"+j.html()+"</span>")});c.isVisible("#heartbeat-div")||c.Confluence.Analytics.publish("rte.notification.concurrent-editing",{numEditors:i,pageId:c.params.pageId,draftType:c.params.draftType})}u&&i<=1&&l.closeMessages(["heartBeat"]);c.setVisible("#heartbeat-div",i>1);b(k).trigger("resize.resizeplugin");c.trigger("editor-heartbeat",a);a=a.editMode;if(a!==f.get("edit-mode")&&!(a==="collaborative"&&f.get("edit-mode")!=="limited")){f.set("edit-mode",a);a=a==="collaborative"?
c.I18n.getText("editor.collaborative.mode.enabled"):c.I18n.getText("editor.collaborative.mode.disabled");s({messageKey:"edit-mode-transition",message:a,disablePublish:true})}}},"json").fail(function(a,b,j){(a.status>=500||a.status===0)&&d.Editor.heartbeatType.recovery();if(a.status===403||a.status===401)c.logError("Heartbeat error: Unauthorized");else if(a.status===405)c.logError("Heartbeat error: Method not allowed");else{c.logError("Server error on heartbeat request:");c.log(j)}c.trigger("rte.heartbeat-error",
a)})},heartbeatType:{normal:function(){I(y)},recovery:function(){I(L)},reset:function(){g&&g.clear();g=y;g.start(d.Editor.heartbeat)},cleanup:function(){if(g){g.clear();g=null}r&&r.abort&&r.abort()}},disableFrame:function(a){b("form",a).each(function(){b(this).unbind();this.onsubmit=function(){return false}});b("a",a).each(function(){var a=b(this),c=a.attr("href");a.unbind();if(c&&c.charAt(0)!=="#"){a.attr("target","_top");a.bind("click",function(b){b.preventDefault();a.blur()})}});b("input, img",
a).each(function(){b(this).unbind()})},previewFrameOnload:function(a,e){var h=require("tinymce");d.Editor.setMode(d.Editor.MODE_PREVIEW);h.activeEditor.setProgressState(false);d.Editor.disableFrame(a);b(".tipsy").remove();var j=b("#main",a)[0];if(f.get("content-type")!=="comment"&&b(j).find("#main-header").length===0){var g=b("#title-heading"),l=g.attr("class");b(j).prepend('<div id="preview-header"><div id="title-heading" class="'+l+'">'+g.html()+"</div></div>")}if(b(c.Rte.getEditor().getBody()).hasClass("resizable")){var m=
b(e||"#previewArea iframe"),i=0,n=0,o,p=m.height();j&&function R(){var a=b(j).outerHeight(true);if(i!==a){a!==m.height()&&m.height(0).height(Math.max(a,p));i=a;n=0}else n++;n<500&&(o=setTimeout(R,500))}();b(k).one("mode-changed.resize-editor",function(a,b){b!==d.Editor.MODE_PREVIEW&&o&&clearTimeout(o)})}else if(h.isIE||h.isOpera){h=b(N).height();g=b("#header-precursor").height()+b("#header").height()+b("#editor-precursor").height();l=b("#savebar-container").height();b("#preview iframe").height(h-
g-l-4);b("#content.edit").height("auto")}},showRichText:function(a){var e=require("tinymce");c.setVisible("#wysiwyg",a);b(".toolbar-group-preview").toggleClass("assistive",!a);b(".toolbar-group-edit").toggleClass("assistive",a);b("#main").toggleClass("active-richtext",a);e.isGecko&&a&&c.Rte.fixEditorFocus(d.Editor.bookmark)},showPreview:function(a){if(f.get("content-type")!=="comment"){var d=b("#content-title");if(d.hasClass("placeholded")){b("#preview-title-text").text("");b("#title-text").text("")}else{b("#preview-title-text").text(d.val());
b("#title-text").text(d.val())}}c.setVisible("#preview",a);b(".toolbar-group-preview").toggleClass("assistive",a);b(".toolbar-group-edit").toggleClass("assistive",!a);b("#main").toggleClass("active-preview",a);b("#full-height-container").length&&b("#full-height-container").toggleClass("active-preview",a)},setMode:function(a){c.debug("Set mode: "+a);if(a===d.Editor.MODE_RICHTEXT){this.showRichText(true);this.showPreview(false)}else if(a===d.Editor.MODE_PREVIEW){this.showPreview(true);this.showRichText(false);
d.Editor.UI.spinner.removeClass("aui-icon-wait")}setTimeout(function(){var a=b(".toolbar-group-preview");a.height(0);a.height();a.height("auto")},1);this.currentEditMode=a;b(k).trigger("mode-changed",[a])},getContentId:function(){return d.getContentId()},addErrorMessage:function(a,d,h){var f=b("#"+a),h=h?"#all-messages":"#editor-messages";f.length?f.empty():f=b("<div></div>").attr("id",a).appendTo(h);c.messages.error(f,{closeable:true,body:d})},changeMode:function(a,e){var h=require("tinymce");c.debug("Change mode: "+
a);e=e||{};if(this.inRichTextMode()&&!c.Rte.BootstrapManager.isInitComplete()||this.currentEditMode===a)return false;var g=this.currentEditMode;c.trigger("rte-changeMode",a);if(a===d.Editor.MODE_PREVIEW){var i=c.Rte.getEditor();if(h.isGecko&&g===d.Editor.MODE_RICHTEXT&&!d.Editor.bookmark)d.Editor.bookmark=h.activeEditor.selection.getBookmark();this.currentEditMode=a;h={contentId:d.getContentId(),contentType:f.get("content-type"),spaceKey:f.get("space-key"),xHtml:i.getContent(),outputType:d.Editor.PREVIEW_OUTPUT_TYPE};
c.safe.ajax({type:"POST",url:m.CONTEXT_PATH+"/pages/rendercontent.action",data:h,success:d.Editor.replysetPreviewArea,timeout:2E4,error:function(){c.trigger("rte-preview-action-selected");c.trigger("rte.preview.error",{status:0});l.closeMessages(["server-offline"]);s({messageKey:"server-offline",message:c.I18n.getText("editor.offline.preview.error"),disablePublish:false});d.Editor.currentEditMode=g;e.errorCallback&&e.errorCallback()}})}else this.setMode(a);a===d.Editor.MODE_RICHTEXT&&b(k).trigger("resize.resizeplugin");
if(g===d.Editor.MODE_PREVIEW)if(h=k.getElementById("editor-preview-iframe")){i=h.contentDocument||h.contentWindow.document;i.removeChild(i.documentElement);b(h).remove()}return false},replysetPreviewArea:function(a){var d=require("tinymce");c.trigger("rte-preview-action-selected");b("#preview-error").remove();d.activeEditor.setProgressState(true);var d=b("#previewArea"),f=b('<iframe id="editor-preview-iframe" src="about:blank" scrolling="yes" frameborder="0"></iframe>');d.html(f);d=f[0].contentDocument||
f[0].contentWindow.document;d.open();d.write(a);d.close()},inRichTextMode:function(){return this.currentEditMode===d.Editor.MODE_RICHTEXT},isNewPage:function(){return b("#createpageform, #createpagetemplate").length>0},onInit:function(){d.Editor.setMode(d.Editor.MODE_RICHTEXT);c.Rte.getEditor().onClick.add(function(){var a=d.Editor.UI.postingDatePicker;a&&a.hide()})},contentChangeHandler:function(){this.contentHasChangedSinceLastSave=true},getCurrentForm:function(){return c.Rte.getEditor().formElement},
setToolBarInactive:function(a){b("#rte-toolbar").toggleClass("disabled",a)},isVisible:function(){return b("#wysiwyg:visible").length>0||b("#preview:visible").length>0}}});
require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor",function(c){var d=require("confluence/legacy"),b=require("jquery"),k=require("ajs");d.Editor=b.extend(d.Editor||{},c);k.toInit(function(b){b(document).ajaxError(function(b,c){if(405===c.status)try{var d=JSON.parse(c.responseText).reason;"undefined"!==typeof d&&"READ_ONLY"===d&&(k.log("*** READ_ONLY mode detected ***"),k.trigger("rte.heartbeat-error",null,c))}catch(n){k.logError("Cannot parse xhr.responseText: "+
n)}});k.bind("init.rte",d.Editor.onInit)});k.Editor=d.Editor});