define("confluence-editor/editor/page-editor-quit-dialog","jquery confluence/templates ajs confluence/meta confluence/legacy window document confluence-editor/editor/page-editor-message confluence/api/constants underscore".split(" "),function(e,l,c,d,g,z,K,m,A,B){function C(b){b.stopPropagation();b.preventDefault();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.show-diff-clicked"});a.showDiffButton.hide();s();a.hideDiffButton.show()}function t(b){b.stopPropagation();b.preventDefault();
c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.hide-diff-clicked"});a.hideDiffButton.hide();a.showDiffButton.show();a.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium");j(h)}function D(b){h=i?f.REVERT:f.DELETE;n();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard"});b.stopPropagation();b.preventDefault();g.Editor.UI.setButtonsState(false,a.buttonsAll);u(d.get("content-id"))}function v(){a.editorForm.append(l.Editor.Page.hiddenInputCancel()).submit()}
function w(a){if(a){a.stopPropagation();a.preventDefault()}c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.keep-draft-clicked",data:{contributorCount:k.length+1}});v()}function E(b){g.Editor.UI.setButtonsState(false,a.buttonsAll);o.save(b);n()}function x(b){b.stopPropagation();b.preventDefault();h=null;c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.draft-status-indicator.click"});p(function(){a.closeButton.show();s()})}function F(b){b.stopPropagation();b.preventDefault();
a.closeButton.show();d.get("new-page")?j(f.DELETE):j(f.REVERT)}function G(b){b.stopPropagation();b.preventDefault();a.dialog.hide()}function s(){a.dialogEl.removeClass("aui-dialog2-medium").addClass("aui-dialog2-xlarge");j(f.SHOW_DIFF);e.ajax({url:A.CONTEXT_PATH+"/rest/tinymce/1/content/"+d.get("page-id")+"/draft/diff",type:"GET"}).success(function(b){a.dialogContent.find(".wiki-content").html(b).children().first().hasClass("diff-context-placeholder")&&a.dialogContent.find("hr").hide()})}function j(b){function c(){return b===
f.SHOW_DIFF&&(h===f.REVERT||h===f.DELETE)}if(b===f.UPDATE||b===f.PUBLISH)q=(new Date).getTime()/1E3;var g=b;c()&&(g=h);a.dialogHeader.html(l.Editor.Page.quitDialogHeader({dialogType:g,contentType:d.get("content-type"),newPage:d.get("new-page")}));a.dialogContent.html(l.Editor.Page.quitDialogContent({dialogType:b,contributors:k,contentType:d.get("content-type"),newDialog:h==null}));a.hideDiffButton=e("#qed-hide-diff-button").click(t);if(!d.get("new-page")){b!==f.SHOW_DIFF&&(h=b);a.showDiffButton=e("#qed-show-diff-button").click(C);
a.showDiffButton.show();a.buttonsAll.push(a.showDiffButton)}if(b===f.DELETE||b===f.REVERT||c()){a.discardButton.show();a.dialogEl.addClass("aui-dialog2-warning")}else a.dialogEl.removeClass("aui-dialog2-warning");a.closeButton.show();a.dialogFooter.find("."+b).show();a.dialog.show()}function H(){n();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.dialog-closed"});a.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium");g.Editor.UI.toggleSavebarBusy(false);
a.dialogFooter.find(".aui-button").hide();a.dialogContent.empty()}function n(){var a=(new Date).getTime()/1E3-q;c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog."+h+".displayed",data:{displayTimeInSeconds:a,contentId:d.get("content-id")}});q=0}function u(b,f){var d=c.contextPath(),d=i?d+"/rest/synchrony/1.0/content/"+b+"/changes/unpublished":d+"/rest/api/content/"+b+"?status=draft";i&&m.suppressMessage("editor.synchrony.revert-page");f=f||0;e.ajax({url:d,type:"DELETE",data:{draftId:b},
contentType:"application/json",dataType:"json"}).done(function(){i&&m.handleMessage("collaborative-editor-discard-error",{type:"success",close:"auto",message:c.I18n.getText("editor.discard-to-published.success.message")});c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-success",data:{contentId:b}});v()}).fail(function(d){if(d.status===409&&f<I){c.trigger("disable-draft-save");u(b,f+1)}else{var e=JSON.parse(d.responseText),h=c.I18n.getText("draft.saving.error.could.not.delete"),
d=d.errors||c.I18n.getText("discard.draft.unknown.error");if(e.data&&e.data.errors&&e.data.errors[0]&&e.data.errors[0].message.key==="content.delete.published"){h=c.I18n.getText("discard.draft.page-published.error.title");d=c.I18n.getText("discard.draft.page-published.error")}c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-error",data:{contentId:b}});c.trigger("enable-draft-save");m.handleMessage("collaborative-editor-discard-error",{type:"error",title:i?c.I18n.getText("editor.discard-to-published.error.title"):
h,message:i?c.I18n.getText("editor.discard-to-published.error.message"):d});a.dialog.hide();g.Editor.UI.setButtonsState(true,a.buttonsAll)}})}function J(a,c){c&&c.contributors&&(k=B.reject(c.contributors,function(a){return a.name===d.get("remote-user")}))}function p(a){g.Editor.Drafts.save({forceSave:i,skipErrorHandler:true,onSuccessHandler:a||e.noop})}var a={},i,y,f={DELETE:"delete",REVERT:"revert",PUBLISH:"publish",UPDATE:"update",SHOW_DIFF:"diff"},k=[],r=false,o={},h,q=0,I=5;return{init:function(b){if(y=
d.getBoolean("shared-drafts")&&(d.get("content-type")==="page"||d.get("content-type")==="blogpost"))if(r){o.save=b&&b.saveHandler;a.publishButton.click(E)}else{i=!d.get("new-page");a.discardButton=e("#qed-discard-button").tooltip({gravity:"s",className:"quit-editor-dialog"});if(g.Editor.isLimitedModeEnabled()&&i){g.Editor.UI.setButtonState(false,a.discardButton);a.discardButton.removeAttr("disabled")}else a.discardButton.click(D);a.saveExitButton=e("#qed-save-exit-button").click(w);a.hideDiffButton=
e("#qed-hide-diff-button").click(t);a.publishButton=e("#qed-publish-button");a.closeButton=e("#qed-close-button").click(G);a.buttonsAll=[a.discardButton,a.saveExitButton,a.showDiffButton,a.hideDiffButton,a.publishButton];a.dialog=c.dialog2("#quit-editor-dialog");a.dialogEl=a.dialog.$el;a.dialogHeader=a.dialogEl.find(".aui-dialog2-header");a.dialogContent=a.dialogEl.find(".aui-dialog2-content");a.dialogFooter=a.dialogEl.find(".aui-dialog2-footer");a.editorForm=e("#wysiwyg").closest("form");e("#rte-show-changes").on("click",
x);e("#rte-show-revert").on("click",F);if(!d.get("new-page"))e("#pluggable-status").on("click","a",x);a.dialog.on("hide",H);c.bind("editor-heartbeat",J);r=true}},process:function(a){if(y){a.stopPropagation();a.preventDefault();e(z).one("editor-heartbeat rte.heartbeat-error",function(){switch(a.target.id){case g.Editor.UI.saveButton.attr("id"):case g.Editor.UI.versionCommentInput.attr("id"):g.Editor.UI.toggleSavebarBusy(true);if(k.length===0)o.save();else{p();j(i?f.UPDATE:f.PUBLISH)}break;case g.Editor.UI.cancelButton.attr("id"):g.Editor.Drafts.isDraftDirty()&&
p();w()}});g.Editor.heartbeat()}},_destroy:function(){r=false}}});