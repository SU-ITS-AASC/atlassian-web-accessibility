AJS.$(function(t){var e=AJS.contextPath(),a=AJS.I18n.getText("confluence.extra.attachments.error.attachmentsversionserror"),n=!(-1==navigator.userAgent.indexOf("Trident/")||-1==navigator.userAgent.indexOf("rv:")&&-1==navigator.appName.indexOf("Netscape"));function i(t){var e=t.find(".vf-slide-viewer"),a=t.find(".vf-slide-loading");AJS.$(a[0]).spin({length:10,radius:10,width:5});var n={width:t.data("width"),height:t.data("height"),attachment:t.data("attachment"),attachmentId:t.data("attachment-id"),attachmentVer:t.data("attachment-ver"),pageId:t.data("page-id"),downloadPath:AJS.contextPath()+t.data("download-path"),usePathAuth:t.data("use-path-auth"),editUrl:AJS.contextPath()+OC.Util.decodeUrl(t.data("edit-url"))};n.allowEdit=t.data("allow-edit")&&"pdf"!==n.editUrl.substring(n.editUrl.length-3);var i=new OC.Slide(n),o=new OC.SlideCache(i),r=new OC.SlideViewerView({model:i,cache:o,el:e});t.append(r.render().el),i.waitUntilReady()}var o={getFieldSetAsParams:function(t){var e={};return t.find("input").each(function(){e[this.name]=this.value}),e},initAttachmentTable:function(n){t(".attachment-menu-bar .ajs-menu-item").unbind(),t(".attachment-menu-bar").ajsMenu(),t(".attachments .attachment-row .attachment-dropdown-actions .action-dropdown",n).addClass("hide-menu"),t(".attachments .attachment-row .attachment-dropdown-actions .action-dropdown .aui-dd-parent .aui-dropdown",n).addClass("hidden"),t(".attachments .attachment-dropdown-actions span",n).addClass("hide-icons"),AJS.Labels.bindOpenDialog(t(".show-labels-editor",n));this.getFieldSetAsParams(n.children("fieldset"));t(".attachments .attachment-row",n).hover(function(){var e=t(this);e.is(".focused")||e.addClass("hovered"),e.find("span").toggleClass("hide-icons hide-menu",!1),e.find(".attachment-dropdown-actions .action-dropdown").dropDown("Standard",{alignment:"right"}),e.find("a.aui-dropdown2-trigger").show()},function(){var e=t(this);e.removeClass("hovered");var a=e.is(".focused");e.find("span").toggleClass("hide-icons",!a),e.find("a.aui-dropdown2-trigger").toggle(a)}).on("click",function(o){if(!t(o.target).is("a")){var r,s,d,c,l,m,h=t(this).find(".attachment-summary-toggle .icon");if(h.toggleClass("icon-section-opened icon-section-closed"),h.closest("tr").next().toggleClass("hidden"),h.is(".icon-section-opened")){h.attr("aria-expanded","false").attr("role","button");var u=h.closest("tr"),p=u.data("attachment-id");u.next().find(".attachment-image-preview:empty").length&&(l=(c=u).closest(".plugin_attachments_table_container"),m={attachmentId:c.data("attachment-id")},t.ajax({cache:!1,data:m,dataType:"html",type:"GET",url:e+"/rest/attachments/1.0/details/preview",success:function(e){var a=t.trim(e)?t(e):null,n=c.next().find(".attachment-image-preview");n.empty(),n.append(a||"<span></span>"),a.is(".vf-slide-viewer-macro")&&(OC.initSlideViewer||i)(a)},error:function(e,n,i){AJS.log("Error retrieving attachment preview: "+i);var o=l.parent(".plugin_attachments_container");l.remove(),t("div.plugin_attachments_upload_container",o).remove(),o.append('<div class="attachments-old-version-error error">'+a+"</div>")}})),!n.find("tr.history-"+p).length&&u.next().find(".attachment-history-wrapper").length&&(s=(r=u).closest(".plugin_attachments_table_container"),(d={}).attachmentId=r.data("attachment-id"),t.ajax({cache:!1,data:d,dataType:"html",type:"GET",url:e+"/pages/plugins/attachments/loadattachmentversions.action",success:function(e){var a=t(e);AJS.Labels.bindOpenDialog(t(".show-labels-editor",a));var n=r.next().find(".attachment-history-wrapper");n.empty(),n.append(a)},error:function(e,n,i){AJS.log("Error retrieving attachment old versions: "+i);var o=s.parent(".plugin_attachments_container");s.remove(),t("div.plugin_attachments_upload_container",o).remove(),o.append('<div class="attachments-old-version-error error">'+a+"</div>")}}))}else h.attr("aria-expanded","true").attr("role","button")}}),t(".attachments .action-trigger",n).click(function(){var e=t(this).parents("tr:first")[0].id;t(".attachments .attachment-row",n).each(function(){var a=t(this);a[0].id==e?(a.addClass("focused"),t("span",a).removeClass("hide-icons"),t("a.aui-dropdown2-trigger",a).show()):a.hasClass("focused")&&(a.removeClass("focused"),t("span",a).addClass("hide-icons"),t("a.aui-dropdown2-trigger",a).hide()),t(".attachment-dropdown-actions .action-dropdown",a).dropDown("Standard",{alignment:"right"})})})},markFileCommentFieldModified:function(t){t.hasClass("blank-search")&&(t.removeClass("blank-search"),t.val(""))},initAttachmentCommentTextFields:function(e){e.find("input[name^='comment_']").each(function(){t(this).focus(function(){o.markFileCommentFieldModified(t(this))})})},renameForms:function(){var e=self.placeFocus;e&&(self.placeFocus=function(){var a=t("div.plugin_attachments_upload_container form");a.attr("name","inlinecommentform"),e(),a.removeAttr("name")})},refreshOtherAttachmentsMacroInstances:function(a,n,i){t("div.plugin_attachments_table_container > fieldset").each(function(){var r=t(this);if(t("input[name='pageId']",r).val()==a){var s=t(this).clone();t("input",s).each(function(){t(this).hasClass("plugin_attachments_macro_render_param")||t(this).remove()});var d=o.getFieldSetAsParams(s);d.old=d.old||"true",t.ajax({cache:!1,type:"GET",url:e+"/pages/plugins/attachments/rendermacro.action",data:d,success:function(e){var a=r.parent(),i=t(e).find("div.plugin_attachments_table_container").html();a.fadeOut("normal",function(){a.html(i),o.initAttachmentTable(a)}),a.fadeIn("normal",function(){AJS.Labels.bindOpenDialog(AJS.$(".show-labels-editor",a))}),n&&n()},error:function(){i&&i()}})}})},initAuiMessageBar:function(){t("#aui-message-bar").length||t("#com-atlassian-confluence").append('<div id="aui-message-bar"></div>')},initUploadForm:function(e){this.initAttachmentCommentTextFields(e),this.initAuiMessageBar();var a=e.children("iframe.plugin_attachments_uploadiframe"),n=e.find("input[name='confirm']");e.find("input[name='file_0']").val("");var i=t("img.plugin_attachments_dropzone_uploadwaiticon"),r=o.getFieldSetAsParams(e.parents("div.plugin_attachments_upload_container").prev("div.plugin_attachments_table_container").children("fieldset"));t(".browse-files",e.parent()).on("click",function(){var t=e.find("input[name='file_0']");t.click(),t.on("change",function(){""!=t.val()&&e.submit()})}),e.submit(function(){if("preview"==r.outputType)return!1;e.find("input[name^='comment_']").each(function(){o.markFileCommentFieldModified(t(this))});return this.target=a.attr("name"),n.addClass("hidden"),i.css("visibility","visible"),a.get(0).processUpload=!0,!0}),a.load(function(){if(this.processUpload){var a=this.contentWindow||this.contentDocument,s=(a=a.document?a.document:a).body,d=t(s).find("div.aui-message.error");d.length>0&&t.trim(d.html()).length>0?(AJS.messages.error("#aui-message-bar",{body:d.html()}),setTimeout(function(){t(".aui-message.error").remove()},3e3),i.css("visibility","hidden"),n.removeClass("hidden")):(o.refreshOtherAttachmentsMacroInstances(r.pageId,function(){i.css("visibility","hidden"),n.removeClass("hidden"),location.reload()},function(){AJS.messages.error("#aui-message-bar",{body:r["i18n-notpermitted"]}),setTimeout(function(){t(".aui-message.error").remove()},3e3),i.css("visibility","hidden"),n.removeClass("hidden")}),e.find("input[name='file_0']").replaceWith(t('<input type="file" name="file_0" size="30">')),e.find("input[name^='comment_']").val(""))}})},hideDropdownIcons:function(){t(".attachments .attachment-row").each(function(){var e=t(this);e.hasClass("focused")&&(e.removeClass("focused"),t("span",e).addClass("hide-icons"))})}};if(t("body").click(function(e){var a=t(e.target);a.parents("td").length&&!a.parents("td").hasClass("attachment-dropdown-actions")&&o.hideDropdownIcons()}),t("div.plugin_attachments_table_container").each(function(){var e=t(this);o.initAttachmentTable(e)}),t.browser.msie||n){var r=t("li.drop-zone-text");r.find("span").text(AJS.$.trim(r.text())),t("form.plugin_attachments_uploadform").removeClass("hidden")}t("form.plugin_attachments_uploadform").each(function(){o.initUploadForm(t(this))}),t(".plugin_attachments_table_container").on("click",".removeAttachmentLink",function(){if(AJS.Attachments.showRemoveAttachmentConfirmDialog)return AJS.Attachments.showRemoveAttachmentConfirmDialog(this),!1}),o.renameForms(),AJS.bind("attachment-macro.refresh",function(t,e){o.refreshOtherAttachmentsMacroInstances(e)})});