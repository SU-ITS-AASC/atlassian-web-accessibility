define("confluence-collaborative-editor-plugin/synchrony-handlers",["jquery","ajs","confluence/meta","confluence/legacy","confluence-editor/editor/page-editor-message","confluence-collaborative-editor-plugin/lib/SyncManager","confluence-collaborative-editor-plugin/synchrony-util","confluence-collaborative-editor-plugin/synchrony-content","confluence-collaborative-editor-plugin/synchrony-presence"],function(e,k,w,p,a,t,h,i,n){var q;var B;var d;var u;var o;var E;var D;var v=[];function y(H,I,G,F){h.time("confluence.editor.synchrony.connect");o=H;d=I;B=G;D=F.pipe(null,function(J){o.destroy();B.onDisconnectedState();return j(J,"collaborative-editor-load-failure",true)});q=e("#syncRev");u=d.getBody();o.on("init",g).on("update",m).on("ack",s).on("connected",b).on("disconnected",f).on("error",l);E=new t(o,{DEBUG_MODE:true});i.bindPostPasteFix();i.readTitleFromRootElement(u);p.Editor.overrideBeforeSave(c);e("#content-title").keyup(i.writeTitleToRootElement)}function r(G,F){if(F.contributors){v=F.contributors;k.unbind(G,r)}}k.bind("editor-heartbeat",r);function g(F){q.val(F.rev.toString())}function s(F){q.val(F.rev.toString());k.trigger("synchrony.entity.ack",{pendingChanges:F.pending.length>0})}function f(){B.onDisconnectedState();k.log("Synchrony disconnected!")}function l(F){if(F.level==="fatal"){k.trigger("editor.error.message",{disablePublish:true})}}function b(F){h.timeEnd("confluence.editor.synchrony.connect");k.log("Synchrony connected.");n.appendTo(F.sid,o,v);B.onConnectedState(o);k.trigger("synchrony.connected");i.fixTinymceCaretContainer(u,d)}function j(G,F,H){return{origin:"synchrony",cause:G,messageKey:F,disablePublish:H}}function c(I){var H=5000;var J=e.Deferred();function G(){J.resolve(I)}function F(L){if(!L.pending.length){o.off("ack",F);q.val(L.rev.toString());G()}}var K=!o.ackState().pending.length;if(K){G()}else{o.on("ack",F);setTimeout(function(){o.off("ack",F);J.reject(j("timeout"))},H)}return e.when(J,D).promise()}function x(G){var F=h.getLatestRevisionWithAttr(G.revisions,"user");return F?F.meta.user:k.I18n.getText("anonymous.name")}function A(F){a.handleMessage("editor.synchrony.page-published",{type:"info",message:k.I18n.getText("editor.synchrony.publish-page.message",k.escapeHtml(F)),close:"auto"});k.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.publish"});k.trigger("editor-shared-drafts-published")}function z(){w.set("new-page",false);w.set("page-id",p.getContentId());w.set("draft-id","0");if(!p.Editor.isLimitedModeEnabled()){p.Editor.UI.setButtonState(true,e("#rte-button-discard"))}}function m(G){if(G.updateType==="remote"){q.val(G.revisions[G.revisions.length-1].rev.toString());if(h.hasRevisionTrigger(G.revisions,"reset")){a.handleMessage("editor.synchrony.revert-page",{type:"info",message:k.I18n.getText("editor.synchrony.revert-page.message",k.escapeHtml(x(G)))});w.set("has-collaborated",false);C();k.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.revert"});k.trigger("editor-shared-drafts-discarded");p.Editor.heartbeat()}if(h.hasRevisionTrigger(G.revisions,"publish")){if(i.isUnpublished()){z()}w.set("has-collaborated",false);C();A(x(G));p.Editor.heartbeat()}if(h.hasRevisionType(G.revisions,"external")){k.trigger("editor.external.change")}var F=h.getLatestRevisionWithAttr(G.revisions,"confVersion");if(F&&F.meta.confVersion){e('meta[name="page-version"]').attr("content",F.meta.confVersion);e('meta[name="ajs-page-version"]').attr("content",F.meta.confVersion);w.set("page-version",F.meta.confVersion)}}setTimeout(function(){if(G.updateType==="init"||G.updateType==="remote"){k.trigger("editor.remote.change");i.readTitleFromRootElement(u)}i.fixTinymceCaretContainer(u,d);if(G.updateType==="local"){if(!d.undoManager.hasUndo()){d.setDirty(false)}k.trigger("editor.local.change")}},0)}function C(){if(o.ackState().pending.length===0){d.setDirty(false)}}return{handle:y}});