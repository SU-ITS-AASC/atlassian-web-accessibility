define("confluence-editor/editor/page-editor",["ajs","confluence/legacy","jquery","document","window","confluence/meta","confluence/api/constants","confluence-editor/editor/page-editor-message"],function(e,t,r,i,o,n,a,s){"use strict";var d,c="editor-preview-iframe",u=e.DarkFeatures.isEnabled("editor.ajax.save")&&!e.DarkFeatures.isEnabled("editor.ajax.save.disable")&&""!==n.get("remote-user"),l=[],g=[],h=[],f=!1,v=1,m=!1,p=function(e){t.Editor.UI.setButtonState(e,t.Editor.UI.saveButton),t.Editor.UI.setButtonState(e,t.Editor.UI.previewButton),t.Editor.UI.setButtonState(e,t.Editor.UI.cancelButton)},E=function(t){var r=(t=t||{}).messageKey||"editor-error-message",i=t.message||e.I18n.getText("editor.generic.refresh");s.handleMessage(r,{title:t.title,type:"error",message:i},function(){t.disablePublish&&p(!1)})},b=function(){return"limited"===n.get("edit-mode")},C=function(e){var t=!0;s.closeMessages(["offline-before-save-error"]);for(var r=0;r<g.length&&(!1===g[r](e)&&(t=!1),!e.isImmediatePropagationStopped());r++);if(!t||e.isDefaultPrevented()||e.isPropagationStopped())return!1;e.preventDefault(),T(e).done(M).fail(y)},y=function(r){var i=r||{};E({messageKey:i.messageKey||"offline-before-save-error",message:i.disablePublish?e.I18n.getText("editor.generic.refresh"):e.I18n.getText("editor.offline.before.save.error"),disablePublish:i.disablePublish}),r&&e.trigger("analytics",{name:"editor.save.error."+r.origin+"."+r.cause}),t.Editor.UI.toggleSavebarBusy(!1),t.Editor.Drafts.bindUnloadMessage()},T=function(e){var t=r.Deferred();return t.resolve(e),t.promise()},I=function(){var i=function(){m=!0,r(t.Editor.getCurrentForm()).submit(),e.trigger("analytics",{name:"confluence.editor.close",data:{source:"publishButton"}})},o=t.Editor.Drafts.getDraftSavingPromise();o?o.always(i):i()},M=I;e.bind("rte-ready",function(){e.Meta.getBoolean("collaborative-content")||r('meta[name="ajs-collaborative-editor-status"]').attr("content","off"),t.Editor.UI.saveButton.bind("click",C)}),e.bind("editor.error.message",function(e,t){E(t)}),e.bind("dismiss.editor.error.message",function(e,t){s.closeMessages([t.messageKey]),t.enablePublish&&p(!0)});var w=function(){var e;for(e=0;e<l.length;e++)t.Editor.UI.cancelButton.click(l[e]);var i=r(t.Editor.getCurrentForm());for(e=0;e<h.length;e++)i.submit(h[e]);r.unbind("init.rte",this)},S=function(t,i,o,n){n.push(o),e.Rte&&e.Rte.BootstrapManager&&e.Rte.BootstrapManager.isInitComplete()?t.bind(i,o):f||(f=!0,r.bind("init.rte",w))},R=function(t,r,i){var o=null;e.Rte&&e.Rte.BootstrapManager&&e.Rte.BootstrapManager.isInitComplete()&&(o=function(e,t,r){e.unbind(t,r)});for(var n=i.pop();n;)o&&o(t,r,n),n=i.pop()};function P(){var t=n.getBoolean("shared-drafts"),r="page"===n.get("content-type")||"blogpost"===n.get("content-type"),i="0"!==e.params.pageId;return r&&(i||t)}function x(e){r("#editpageform").find("input[name='atl_token']").val(e),n.set("atl-token",e),n.set("atlassian-token",e),r("#atlassian-token").attr("content",e)}return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_SOURCE:"source",MODE_PREVIEW:"preview",PREVIEW_OUTPUT_TYPE:"PREVIEW",currentEditMode:null,contentHasChangedSinceLastSave:!1,sourceInitialValue:!1,isPublishing:function(e){return void 0!==e&&(m=e),m},isLimitedModeEnabled:b,overrideBeforeSave:function(e){T=e},overrideSave:function(e){M=e},restoreDefaultSave:function(){M=I},getNumConcurrentEditors:function(){return v},addCancelHandler:function(e){S(t.Editor.UI.cancelButton,"click",e,l)},addSaveHandler:function(e){g.push(e)},addSubmitHandler:function(e){S(r(t.Editor.getCurrentForm()),"submit",e,h)},removeAllCancelHandlers:function(){R(t.Editor.UI.cancelButton,"click",l)},removeAllSaveHandlers:function(){R(t.Editor.UI.saveButton,"click",g)},removeAllSubmitHandlers:function(){R(r(t.Editor.getCurrentForm()),"submit",h)},hasContentChanged:function(){return!(!this.inRichTextMode()&&!this.contentHasChangedSinceLastSave)&&this.editorHasContentChanged()},editorHasContentChanged:function(){return null==e.Rte.getEditor()?(e.debug("Confluence.Editor: editorHasContentChanged - No active editor present. Returning false."),!1):e.Rte.Content.editorHasContentChanged()},isEmpty:function(){var t=r(e.Rte.getEditor().getContent()).text();return!r.trim(t)},getResumeDraftUrl:function(){var t=[];return t.push(a.CONTEXT_PATH),t.push("/pages/"+(e.params.newPage?"create":"edit")+e.params.draftType+".action"),t.push("?useDraft=true"),t.push("&pageId="+e.params.pageId),t.push("&contentChanged="+this.hasContentChanged()),this.getCurrentForm().spaceKey&&t.push("&spaceKey="+n.get("space-key")),t.join("")},getCurrentTitle:function(){return r("#content-title")&&r("#content-title").val()},contentFormSubmit:function(e){return!b()&&t.Editor.Drafts.isSharedDraftsEnabled()||t.Editor.Drafts.unBindUnloadMessage(),r(".editable-title #content-title").prop("disabled",!0),!0},metadataSyncRequired:P,heartbeat:function(){var o={dataType:"json",contentId:n.get("content-id"),draftType:n.get("content-type"),spaceKey:e.params.spaceKey,contributorsHash:n.get("contributors-hash")};d=e.safe.post(a.CONTEXT_PATH+"/json/startheartbeatactivity.action",o,function(o){if(!P()&&o)return x(o.atlToken),e.Meta.set("shared-drafts","legacy"!==o.editMode),void e.trigger("rte.heartbeat",o);if(!(o&&o.atlToken&&o.activityResponses instanceof Array))return e.trigger("rte.heartbeat-error","Invalid server response"),e.logError("Unexpected server response for heartbeat:"),void e.log(o);n.set("contributors-hash",o.contributorsHash),e.Meta.set("shared-drafts","legacy"!==o.editMode);var d=o.activityResponses;if(x(o.atlToken),t.Editor.heartbeatType.normal(),e.trigger("rte.heartbeat",d),(v=(d.length||0)+1)>1){var c=u?0===r("#reliable-other-users-span").length?r("<span id='reliable-other-users-span'></span>"):r("#reliable-other-users-span"):r("#other-users-span");c.empty();for(var l=0;l<v-1;++l){l>0&&c.append(", ");var g=d[l];c.append(e("a").attr("href",a.CONTEXT_PATH+"/display/~"+encodeURIComponent(g.userName)).text(g.fullName)),null!=g.lastEditMessage&&c.append(" ").append(e("span").addClass("smalltext").text(g.lastEditMessage))}u&&(s.isDisplayed(["heartBeat"])||""===c.html().trim()||s.handleMessage("heartBeat",{type:"info",message:e.I18n.getText("heartbeat.page.edited.info","<span id='reliable-other-users-span'>"+c.html()+"</span>")})),e.isVisible("#heartbeat-div")||e.Confluence.Analytics.publish("rte.notification.concurrent-editing",{numEditors:v,pageId:e.params.pageId,draftType:e.params.draftType})}u&&v<=1&&s.closeMessages(["heartBeat"]),e.setVisible("#heartbeat-div",v>1),r(i).trigger("resize.resizeplugin"),e.trigger("editor-heartbeat",o),function(t){if(t!==n.get("edit-mode")){if("collaborative"===t&&"limited"!==n.get("edit-mode"))return;var r;n.set("edit-mode",t),r="collaborative"===t?e.I18n.getText("editor.collaborative.mode.enabled"):e.I18n.getText("editor.collaborative.mode.disabled"),E({messageKey:"edit-mode-transition",message:r,disablePublish:!0})}}(o.editMode)},"json").fail(function(r,i,o){(r.status>=500||0===r.status)&&t.Editor.heartbeatType.recovery(),403===r.status||401===r.status?e.logError("Heartbeat error: Unauthorized"):(e.logError("Server error on heartbeat request:"),e.log(o)),e.trigger("rte.heartbeat-error",r)})},heartbeatType:function(){var r;function i(e){r!==e&&(r&&r.clear(),e.start(t.Editor.heartbeat),r=e)}var o,a,s,c,u=n.getNumber("heartbeat-interval")||3e4,l={start:function(t){e.debug("Changing heartbeat to the normal scheduler"),o=setInterval(t,u)},clear:function(){clearInterval(o)}},g=(c=Math.max(u/5,5e3),{start:function(t){e.debug("Changing heartbeat to the recovery scheduler"),s=0;var r=function(){t();var e=c*Math.pow(2,s);a=setTimeout(r,Math.min(e,3e5)),s++};a=setTimeout(r,c)},clear:function(){clearTimeout(a)}});return{normal:function(){i(l)},recovery:function(){i(g)},reset:function(){r&&r.clear(),(r=l).start(t.Editor.heartbeat)},cleanup:function(){r&&(r.clear(),r=null),d&&d.abort&&d.abort()}}}(),disableFrame:function(e){r("form",e).each(function(){r(this).unbind(),this.onsubmit=function(){return!1}}),r("a",e).each(function(){r(this).attr("target","_top").unbind()}),r("input, img",e).each(function(){r(this).unbind()})},previewFrameOnload:function(a,s){var d=require("tinymce");t.Editor.setMode(t.Editor.MODE_PREVIEW),d.activeEditor.setProgressState(!1),t.Editor.disableFrame(a),r(".tipsy").remove();var c=r("#main",a)[0];if("comment"!==n.get("content-type")&&0===r(c).find("#main-header").length){var u=r("#title-heading"),l=u.attr("class");r(c).prepend('<div id="preview-header"><div id="title-heading" class="'+l+'">'+u.html()+"</div></div>")}if(r(e.Rte.getEditor().getBody()).hasClass("resizable")){var g,h=r(s||"#previewArea iframe"),f=0,v=0,m=h.height();c&&function e(){var t=r(c).outerHeight(!0);f!==t?(t!==h.height()&&h.height(0).height(Math.max(t,m)),f=t,v=0):v++,v<500&&(g=setTimeout(e,500))}(),r(i).one("mode-changed.resize-editor",function(e,r){r!==t.Editor.MODE_PREVIEW&&g&&clearTimeout(g)})}else if(d.isIE||d.isOpera){var p=r(o).height(),E=r("#header-precursor").height()+r("#header").height()+r("#editor-precursor").height(),b=r("#savebar-container").height();r("#preview iframe").height(p-E-b-4),r("#content.edit").height("auto")}},showRichText:function(i){var o=require("tinymce");e.setVisible("#wysiwyg",i),r(".toolbar-group-preview").toggleClass("assistive",!i),r(".toolbar-group-edit").toggleClass("assistive",i),r("#main").toggleClass("active-richtext",i),o.isGecko&&i&&e.Rte.fixEditorFocus(t.Editor.bookmark)},showPreview:function(t){if("comment"!==n.get("content-type")){var i=r("#content-title");i.hasClass("placeholded")?(r("#preview-title-text").text(""),r("#title-text").text("")):(r("#preview-title-text").text(i.val()),r("#title-text").text(i.val()))}e.setVisible("#preview",t),r(".toolbar-group-preview").toggleClass("assistive",t),r(".toolbar-group-edit").toggleClass("assistive",!t),r("#main").toggleClass("active-preview",t),r("#full-height-container").length&&r("#full-height-container").toggleClass("active-preview",t)},showSource:function(e){e?this.showSourceArea():this.hideSourceArea(),r("#main")[e?"addClass":"removeClass"]("active-source")},setMode:function(o){e.debug("Set mode: "+o),o===t.Editor.MODE_RICHTEXT?(this.showRichText(!0),this.showPreview(!1),this.showSource(!1)):o===t.Editor.MODE_SOURCE?(this.showSource(!0),this.showRichText(!1),this.showPreview(!1)):o===t.Editor.MODE_PREVIEW&&(this.showPreview(!0),this.showRichText(!1),this.showSource(!1),t.Editor.UI.spinner.removeClass("aui-icon-wait")),setTimeout(function(){var e=r(".toolbar-group-preview");e.height(0),e.height(),e.height("auto")},1),this.currentEditMode=o,r(i).trigger("mode-changed",[o])},getContentId:function(){return t.getContentId()},addErrorMessage:function(t,i,o){var n=r("#"+t),a=o?"#all-messages":"#editor-messages";n.length?n.empty():n=r("<div></div>").attr("id",t).appendTo(a),e.messages.error(n,{closeable:!0,body:i})},changeMode:function(o,d){var u=require("tinymce");if(e.debug("Change mode: "+o),d=d||{},this.inRichTextMode()&&!e.Rte.BootstrapManager.isInitComplete())return!1;if(this.currentEditMode===o)return!1;var l=this.currentEditMode;if(e.trigger("rte-changeMode",o),o===t.Editor.MODE_PREVIEW){var g=e.Rte.getEditor();l===t.Editor.MODE_SOURCE&&t.Editor.transferSourceToEditor(),u.isGecko&&l===t.Editor.MODE_RICHTEXT&&!t.Editor.bookmark&&(t.Editor.bookmark=u.activeEditor.selection.getBookmark()),this.currentEditMode=o;var h={contentId:t.getContentId(),contentType:n.get("content-type"),spaceKey:n.get("space-key"),xHtml:g.getContent(),outputType:t.Editor.PREVIEW_OUTPUT_TYPE};e.safe.ajax({type:"POST",url:a.CONTEXT_PATH+"/pages/rendercontent.action",data:h,success:t.Editor.replysetPreviewArea,timeout:2e4,error:function(){e.trigger("rte-preview-action-selected"),e.trigger("rte.preview.error",{status:0}),s.closeMessages(["server-offline"]),E({messageKey:"server-offline",message:e.I18n.getText("editor.offline.preview.error"),disablePublish:!1}),t.Editor.currentEditMode=l,d.errorCallback&&d.errorCallback()}})}else this.setMode(o);if(o===t.Editor.MODE_RICHTEXT&&r(i).trigger("resize.resizeplugin"),l===t.Editor.MODE_PREVIEW){var f=i.getElementById(c);if(f){var v=f.contentDocument||f.contentWindow.document;v.removeChild(v.documentElement),r(f).remove()}}return!1},replysetPreviewArea:function(t){var i=require("tinymce");e.trigger("rte-preview-action-selected"),r("#preview-error").remove(),i.activeEditor.setProgressState(!0);var o=r("#previewArea"),n=r('<iframe id="'+c+'" src="about:blank" scrolling="yes" frameborder="0"></iframe>');o.html(n);var a=n[0].contentDocument||n[0].contentWindow.document;a.open(),a.write(t),a.close()},inRichTextMode:function(){return this.currentEditMode===t.Editor.MODE_RICHTEXT},isNewPage:function(){return r("#createpageform, #createpagetemplate").length>0},onInit:function(){var e=require("tinymce");t.Editor.setMode(t.Editor.MODE_RICHTEXT),e.activeEditor.onClick.add(function(e,r){var i=t.Editor.UI.postingDatePicker;i&&i.hide()})},contentChangeHandler:function(){this.contentHasChangedSinceLastSave=!0},getCurrentForm:function(){return require("tinymce").activeEditor.formElement},transferSourceToEditor:function(){var e=t.Editor;if(e.sourceInitialValue){var r=e.getSourceAreaVal();if(r!==e.sourceInitialValue){var i=require("tinymce").activeEditor;i.setContent(r),i.setDirty(r)}}e.sourceInitialValue=!1},hideSourceArea:function(){r("#editor-html-source-container").addClass("hidden"),this.setToolBarInactive(!1),this.transferSourceToEditor(),r("#rte-button-source-mode").removeClass("active"),r("#rte-button-publish").unbind("click.source-save")},showSourceArea:function(){var e=require("tinymce");r("#editor-html-source-container").removeClass("hidden"),this.setSourceAreaHeight(),this.setToolBarInactive(!0),this.sourceInitialValue=e.activeEditor.getContent(),this.setSourceAreaVal(this.sourceInitialValue),r("#rte-button-source-mode").addClass("active"),r("#rte-button-publish").bind("click.source-save",t.Editor.transferSourceToEditor)},getSourceAreaVal:function(){return r("#editor-html-source").val()},setSourceAreaVal:function(e){r("#editor-html-source").val(e)},setSourceAreaHeight:function(){var t=e.Rte.getTinyMceEditorMinHeight();e.debug("HTML source height= "+t);var i=r("#editor-html-source")[0].scrollHeight;i>t&&(t=i,e.debug("ACTUAL HEIGHT "+i)),r("#editor-html-source-container").height(t+"px")},setToolBarInactive:function(e){r("#rte-toolbar").toggleClass("disabled",e)},isVisible:function(){return r("#wysiwyg:visible").length>0||r("#editor-html-source-container:visible").length>0||r("#preview:visible").length>0}}}),require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor",function(e){var t=require("confluence/legacy"),r=require("jquery"),i=require("ajs");t.Editor=r.extend(t.Editor||{},e),i.toInit(function(e){i.bind("init.rte",t.Editor.onInit)}),i.Editor=t.Editor});