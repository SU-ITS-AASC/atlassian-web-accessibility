define("confluence-quick-edit/handlers/page",["jquery","ajs","confluence/legacy","confluence/meta","confluence-quick-edit/handlers/shortcut","confluence/aui-overrides","confluence/analytics-support","window","confluence/api/browser","confluence-editor/editor/page-editor-message"],function(e,t,n,i,o,r,a,c,d,s){"use strict";var l,u,f=new d(c.navigator.userAgent);function g(){var t=e("#editPageLink");t.find(".aui-icon").css("visibility","visible"),t.parent().spinStop()}function h(){var e=i.get("content-type");return i.get("collaborative-content")&&("page"===e||"blogpost"===e)}function p(t,n,i){var o={pageId:i,blockIndex:-1,columnIndex:-1,index:-1,offset:0,hasBlock:function(){return-1!==this.blockIndex}},r=!1,a=function(e,t){var i=e.offset();c(e)&&(o.index=t,o.offset=n-i.top,r=!0)},c=function(e){var t=e.offset();return t.top-8<=n&&t.top+e.height()>=n};if(1===t.children().length&&t.children().first().hasClass("contentLayout2")){if(t.children().first().children().each(function(t){o.hasBlock()||c(e(this))&&(o.blockIndex=t)}),o.hasBlock()){var d=t.children().first().children().eq(o.blockIndex).find(".innerCell");d.each(function(t){if(-1===o.columnIndex){var n=e(this).children().length;n>0&&(n<2?e(this).children().first().height()>25&&(o.columnIndex=t):o.columnIndex=t)}}),d.eq(o.columnIndex).children().each(function(t){r||a(e(this),t)})}}else t.children().each(function(t){r||a(e(this),t)});return r?o:null}function m(i){var o=require("tinymce");if(E.disable(),r.metaToParams(),t.DarkFeatures.isEnabled("confluence.view.edit.transition")){var a=e("#main-content"),d=e("#header"),s=e("#main-header"),l=c.pageYOffset+d.outerHeight()+s.outerHeight();u=p(a,l,t.params.pageId),t.trigger("quick-edit.viewport.saved");var f=function(){e(o.activeEditor.getWin().document).find("body#tinymce").addClass("page-edit"),e("#content").css({paddingRight:0}),t.unbind("quickedit.visible",f)};t.bind("quickedit.visible",f)}var g=i.$form,h="page"===t.Meta.get("content-type")?"doeditpage":"doeditblogpost",m=t.contextPath()+"/pages/"+h+".action?pageId="+n.getContentId();e(".ia-splitter-left").remove();try{e("#main").unwrap()}catch(e){}e("#rte").removeClass("editor-default").addClass("editor-fullheight"),i.$container.children().remove(),e(".editor-container").children().eq(0).unwrap(),g.attr({class:"editor aui",action:m,name:"editpageform",id:"editpageform",style:""}),i.$container.append(g),i.$container.removeClass("view").addClass("edit"),e("body").addClass("contenteditor edit")}function v(i){var o,r;require("tinymce");e("#editor-precursor").show(),e("#rte-savebar").find(".toolbar-split-left").show(),c.history.pushState?(o=e("#editPageLink").attr("href"))!=c.location.pathname+c.location.search&&(history.pushState({quickEdit:!0},"",o),t.trigger("rte-quick-edit-push-state",o)):(c.location.hash="editor",t.trigger("rte-quick-edit-push-hash")),function(t){if(t.permissions)for(var n in t.permissions)e("#"+n).attr("value",t.permissions[n])}(i.content),e("#originalVersion").val(i.content.pageVersion),t.Meta.set("page-version",i.content.pageVersion),t.Meta.set("page-title",i.content.title),e('meta[name="page-version"]').attr("content",i.content.pageVersion),e('meta[name="ajs-page-version"]').attr("content",i.content.pageVersion),e("#syncRev").val(i.content.syncRev),t.Meta.set("conf-revision",i.content.confRev),e('meta[name="ajs-conf-revision"]').attr("content",i.content.confRev),r=i.content.atlToken,t.Meta.set("atl-token",r),e('input[name="atl_token"]').val(r),t.trigger("analyticsEvent",{name:"quick-edit-success"}),e("#navigation").remove();var a=new Date,d=function(e,t){if(a){if("keydown"===t.type){if([91,92,93,224,33,34,37,38,39,40,16,17,18,20,112,113,114,115,116,117,118,119,120,121,122,123].indexOf(t.keyCode)>-1)return}var o=new Date-a;a=null,n.Analytics.publish("confluence.editor.transition.firstkeydown",{delay:o}),i.editor.onKeyDown.remove(d),i.editor.onChange.remove(d)}};i.editor.onKeyDown.add(d),i.editor.onChange.add(d),n.debugTimeEnd("confluence.editor")}function b(t){setTimeout(function(){if(u){var n,i,o=e(t.getBody());n=u.hasBlock()?(i=o,i.children().first().children().eq(u.blockIndex).find(".innerCell")).eq(u.columnIndex).children().eq(u.index):o.children().eq(u.index),t.getWin().scrollTo(0,n.offset().top+u.offset),e("#main").css("visibility","visible")}})}function y(e){t.trigger("rte-collaborative-content-ready",e)}function k(n,o){if(o)switch(o.status){case 423:var r=JSON.parse(o.responseText).user;return g(),void t.MessageHandler.flag({type:"info",title:t.I18n.getText("editor.unavailable.title"),body:t.I18n.getText("limited.mode.existing.editor.body",t.escapeHtml(r)),close:"manual"});case 412:return g(),s.handleMessage("collab.edit.user.limit.reached",{type:"warning",title:t.I18n.getText("collab.edit.user.limit.msg.title"),message:t.I18n.getText("collab.edit.user.limit.msg.body"),close:"manual"}),void a.publish("collab.edit.user.limit.reached",{browserName:f.friendlyName(),browserVersion:f.version(),pageId:i.get("page-id"),editMode:"quick",numEditors:i.get("max-number-editors")})}c.location=e("#editPageLink").attr("href")}var E={editShortcut:o.createShortcut("e","#editPageLink"),activateEventHandler:function(n){if(!(n.metaKey||n.shiftKey||n.ctrlKey||n.altKey||2===n.which||3===n.which))if(n.preventDefault(),(i=l)&&"pending"===i.state())t.debug("Editor is being activated. Ignoring handler...");else{var i,o;l=E.activateEditor(),(o=e("#editPageLink")).find(".aui-icon").css("visibility","hidden"),o.parent().spin({left:"10px"});var r=e("#draft-status-lozenge");""!==r.text()&&t.Confluence.Analytics.publish("confluence.drafts.referrer",{referrerPage:"view",lozengeType:r.text()})}},enable:function(){if(e("body").is(".theme-default")){var n=e("#editPageLink");n.bind("click",E.activateEventHandler),n.removeClass("full-load"),E.editShortcut.bind(),t.debug("QuickPageEdit enabled")}else t.debug("QuickPageEdit not enabled")},activateEditor:function(){n.debugTime("confluence.editor"),h()&&t.trigger("rte-quick-edit-init");var i=e("#content").find(".quick-comment-form"),o=function(){var n=require("tinymce").activeEditor.getWin(),i=p(e(n.document).find("#tinymce"),n.pageYOffset,t.params.pageId);i&&(sessionStorage.viewPort=JSON.stringify(i))};return t.Confluence.QuickEdit.activateEditor({fetchContent:function(){var i=new e.Deferred;n.debugTime("confluence.editor.quick.fetchContent");var o=e.ajax({url:t.contextPath()+"/rest/tinymce/1/content/"+n.getContentId()+".json",cache:!1});return o.success(function(e){t.Meta.get("edit-mode")&&t.Meta.get("edit-mode")!==e.editMode&&i.reject("edit mode change",o),n.debugTimeEnd("confluence.editor.quick.fetchContent"),h()&&y(e),t.bind("synchrony-events-bound",function n(){y(e),t.unbind("synchrony-events-bound",n)}),i.resolve(e)}),o.error(function(e,t,n){i.reject("error fetching content",e)}),i}(),$container:e("#content"),$form:i.length?i:e('<form method="post"></form>'),preInitialise:m,postInitialise:v,saveHandler:function(){t.DarkFeatures.isEnabled("confluence.view.edit.transition")&&o(),n.Editor.getNumConcurrentEditors()>1&&t.Confluence.Analytics.publish("rte.notification.concurrent-editing.save",{numEditors:n.Editor.getNumConcurrentEditors(),pageId:t.params.pageId,draftType:t.params.draftType})},cancelHandler:function(){t.DarkFeatures.isEnabled("confluence.view.edit.transition")&&o(),n.Editor.getNumConcurrentEditors()>1&&t.Confluence.Analytics.publish("rte.notification.concurrent-editing.cancel",{numEditors:n.Editor.getNumConcurrentEditors(),pageId:t.params.pageId,draftType:t.params.draftType})},plugins:t.Confluence.Editor._Profiles.createProfileForPageEditor({versionComment:!0,notifyWatchers:!0}).plugins,onInitialise:function(e){t.DarkFeatures.isEnabled("confluence.view.edit.transition")&&e.onLoad.add(b)}}).fail(k)},disable:function(){t.debug("QuickPageEdit disabled."),E.editShortcut.unbind(),e("#editPageLink").unbind("click",E.activateEventHandler)}};return t.Confluence.QuickEdit.register(E),{disable:E.disable,_objForTesting:{onFailActivateEditor:k}}}),require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/handlers/page","AJS.Confluence.QuickEdit.QuickEditPage");