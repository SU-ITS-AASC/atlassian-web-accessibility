define("confluence-editor/wiki-autoformat",["ajs","jquery","document","window"],function(k,j,m,u){var h=function(v,w){function n(a){return j("<div>").append(a.cloneNode(!0)).html()}function x(a,b,f){if(!b)throw Error("text node is null");3!==b.nodeType&&(b=b.childNodes[f-1],f=b.length);for(;b&&3===b.nodeType;b=b.previousSibling){-1==f&&(f=b.nodeValue.length);if(f>a)return{container:b,offset:f-a};if(f==a){f=0;for(a=b.parentNode;b=b.previousSibling;)f++;return{container:a,offset:f}}a-=f;f=-1}return null}
function p(a){var b,f;if(!a||!a.collapsed)throw Error("range is null or not collapsed");b=a.startContainer;f=a.startOffset;if(1===b.nodeType&&0<f)if(b=b.childNodes[a.startOffset-1],3===b.nodeType)f=b.nodeValue.length;else return"";else if(3!==b.nodeType)return"";a=b.nodeValue.substring(0,f);for(b=b.previousSibling;b&&3===b.nodeType;b=b.previousSibling)a=b.nodeValue+a;return a}function i(a,b,f,c){return{handles:function(b){var f=!1,b=b.selection.getRng(!0),f=b.commonAncestorContainer||{};return!b.collapsed||
j(f).closest("pre,.text-placeholder").length||c&&j(f).closest(c).length?!1:f=a.test(p(b))},execute:function(c,g,h){var d,e,i=1;d=j.browser.msie?g.keyCode:g.which;32===d?c.execCommand("mceInsertContent",!1,"&nbsp;"):c.execCommand("mceInsertContent",!1,String.fromCharCode(d));c.undoManager.beforeChange();c.undoManager.add();d=c.selection.getRng(!0);e=p(d);"|"==e[e.length-1]&&(e+=" ",i=0);e=a.exec(e.substring(0,e.length-1));i=x(e[1].length+i,d.commonAncestorContainer,d.startOffset);d.setStart(i.container,
i.offset);i=j(d.commonAncestorContainer);c.selection.setRng(d);i.closest(".wysiwyg-macro-body").length&&d.toString()==i.text()?(i[0].innerHTML="<br>",c.selection.select(i[0].childNodes[0]),c.selection.collapse(!0)):c.execCommand("delete",!1,{},{skip_undo:!0});b(e,c.selection.getRng(!0));q=c.selection.getRng(!0);if(f)return h.preventDefault(),h.stopPropagation(),o.dom.Event.cancel(g),k.Rte.showElement(q.startContainer),!1}}}function r(){this.handlers={}}function e(a,b,f,d,e){var a=a.charCodeAt(0),
h=k.Rte.getResourceUrlPrefix()+"/images/icons/emoticons/"+e,b=i(b,function(){var a=c.dom.createHTML("img",{src:h,alt:c.getLang(d),title:c.getLang(d),border:0,"class":"emoticon emoticon-"+f,"data-emoticon-name":f});c.execCommand("mceInsertContent",!1,a,{skip_undo:!0})},!0);this.imagePath=h;g.registerHandler(a,b)}function s(a,b){var f=c.formatter.get(a)[0],f=c.dom.create(f.inline,{style:f.styles});f.appendChild(m.createTextNode(b+"{$caret}"));c.execCommand("mceInsertContent",!1,n(f),{skip_undo:!0});
c.formatter.remove(a)}var o=require("tinymce"),q;if(!k.Meta.get("remote-user")||!k.Meta.get("confluence.prefs.editor.disable.autoformat")){r.prototype={registerHandler:function(a,b){this.handlers[a]||(this.handlers[a]=[]);this.handlers[a].push(b)},executeHandlers:function(a,b,c,d){var e=!0;j.each(this.handlers[a]||[],function(a,g){if(g.handles(b))return e=g.execute(b,c,d),!1});return e}};var c=w.editor,g=new r,d=[new e(")",h.regularExpressions._REGEXES_EMOTICON.SMILE,"smile","emotions_dlg.smile",
"smile.png"),new e("(",h.regularExpressions._REGEXES_EMOTICON.SAD,"sad","emotions_dlg.sad","sad.png"),new e("P",h.regularExpressions._REGEXES_EMOTICON.CHEEKY,"cheeky","emotions_dlg.tongue","tongue.png"),new e("p",h.regularExpressions._REGEXES_EMOTICON.CHEEKY_2,"cheeky","emotions_dlg.tongue","tongue.png"),new e("D",h.regularExpressions._REGEXES_EMOTICON.LAUGH,"laugh","emotions_dlg.biggrin","biggrin.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.WINK,"wink","emotions_dlg.wink","wink.png"),new e(")",
h.regularExpressions._REGEXES_EMOTICON.THUMBS_UP,"thumbs-up","emotions_dlg.thumbs_up","thumbs_up.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.THUMBS_DOWN,"thumbs-down","emotions_dlg.thumbs_down","thumbs_down.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.INFORMATION,"information","emotions_dlg.information","information.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.TICK,"tick","emotions_dlg.check","check.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.CROSS,"cross",
"emotions_dlg.error","error.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.WARNING,"warning","emotions_dlg.warning","warning.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.PLUS,"plus","emotions_dlg.add","add.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.MINUS,"minus","emotions_dlg.forbidden","forbidden.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.QUESTION,"question","emotions_dlg.help_16","help_16.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.LIGHT_ON,"light-on",
"emotions_dlg.lightbulb_on","lightbulb_on.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.LIGHT_OFF,"light-off","emotions_dlg.lightbulb","lightbulb.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.YELLOW_STAR,"yellow-star","emotions_dlg.star_yellow","star_yellow.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.YELLOW_STAR_2,"yellow-star","emotions_dlg.star_yellow","star_yellow.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.RED_STAR,"red-star","emotions_dlg.star_red","star_red.png"),
new e(")",h.regularExpressions._REGEXES_EMOTICON.GREEN_STAR,"green-star","emotions_dlg.star_green","star_green.png"),new e(")",h.regularExpressions._REGEXES_EMOTICON.BLUE_STAR,"blue-star","emotions_dlg.star_blue","star_blue.png"),new e("3",h.regularExpressions._REGEXES_EMOTICON.HEART,"heart","emotions_dlg.heart","heart.png"),new e("3",h.regularExpressions._REGEXES_EMOTICON.BROKEN_HEAR,"broken-heart","emotions_dlg.broken_heart","broken_heart.png")],l,t=[];for(l=0;l<d.length;l++)t[l]=new u.Image,t[l].src=
d[l].imagePath;j.each({"*":"bold",_:"italic","~":"subscript","^":"superscript","+":"underline","-":"strikethrough"},function(a,b){var c=RegExp("(?:[\\s\\xA0\\u200b\\uFEFF]+|^)(\\"+a+"(?=[^\\s"+a+"])([^"+a+"]*?[^\\s]))$");g.registerHandler(a.charCodeAt(0),i(c,function(a){s(b,a[2])},!0))});c.formatter.register("code",{inline:"code"});g.registerHandler(125,i(/(?:[\s\xA0\u200b]+|^)({{(?=[^\s])([^}]*?[^\s])})$/,function(a){s("code",a[2])},!0));for(l=1;6>=l;l++)(function(a){g.registerHandler(32,i(RegExp("^\\u200b?(h"+
a+"\\.)$"),function(){c.execCommand("formatBlock",!1,"h"+a,{skip_undo:!0})},!0))})(l);g.registerHandler(32,i(/^\u200b?(bq\.)$/,function(){c.execCommand("formatBlock",!1,"blockquote",{skip_undo:!0})},!0));g.registerHandler(32,i(/^\u200b?(\*)$/,function(){c.plugins.lists.applyList("UL","OL")},!0));g.registerHandler(32,i(/^\u200b?(\#)$/,function(){c.plugins.lists.applyList("OL","UL")},!0));g.registerHandler(32,i(/^\u200b?(1\.)$/,function(){c.plugins.lists.applyList("OL","UL")},!0));g.registerHandler(32,
i(/^\u200b?(\-)$/,function(){var a=c.dom,b;c.plugins.lists.applyList("UL","OL");if(b=a.getParent(c.selection.getNode(),"OL,UL"))a.setStyles(b,{listStyleType:"square"}),b.removeAttribute("data-mce-style")},!0));k.trigger("confluence.editor.registerHandlers",{handlerManager:g,createHandler:i,ed:c});d=i(/((\<\-\-?\>)([^\s-]*))$/,function(a){c.execCommand("mceInsertContent",!1,"\u2194"+a[3],{skip_undo:!0})},!1);g.registerHandler(32,d);g.registerHandler(13,d);d=i(/((\-\-?\>)([^\s-]*))$/,function(a){c.execCommand("mceInsertContent",
!1,"\u2192"+a[3],{skip_undo:!0})},!1);g.registerHandler(32,d);g.registerHandler(13,d);d=i(/((\<\-\-?)([^\s-]*))$/,function(a){c.execCommand("mceInsertContent",!1,"\u2190"+a[3],{skip_undo:!0})},!1);g.registerHandler(32,d);g.registerHandler(13,d);g.registerHandler(32,i(/[^-]*[\s](\-\-\-?)$/,function(a){c.execCommand("mceInsertContent",!1,2===a[1].length?"\u2013":"\u2014",{skip_undo:!0})},!1));d=i(/(([^\s-]+)(\-\-\-?)([^\s-]+))$/,function(a){c.execCommand("mceInsertContent",!1,a[2]+(2===a[3].length?
"\u2013":"\u2014")+a[4],{skip_undo:!0})},!1);g.registerHandler(32,d);g.registerHandler(13,d);d=i(/^\u200b?(\-\-\-\-)$/,function(){c.execCommand("mceInsertContent",!1,"<hr />",{skip_undo:!0})},!0);g.registerHandler(32,d);g.registerHandler(13,d);g.registerHandler(13,i(/(^\u200b?\|\|\s*(?:[^|]*\s?\|\|\s?)+$)/,function(a){var b="<table class='confluenceTable'><tr>",f="",d=!0,a=j(a[1].slice(2,-2).split("||")).map(function(a){a=j.trim(this);d=d&&""==a;return a});d&&(a[0]=k.I18n.getText("editor.autoformat.sampletext.firstcell"));
for(var e=0,g=a.length;e<g;e++)b+="<th class='confluenceTh'>"+a[e]+"</th>",f+="<td class='confluenceTd'>"+k.Rte.ZERO_WIDTH_WHITESPACE+"</td>";c.execCommand("mceInsertContent",!1,b+("</tr><tr>"+f+"</tr></table>"),{skip_undo:!0});c.selection.select(j(c.selection.getRng(!0).commonAncestorContainer).parents("table").find(d?"th":"td")[0].childNodes[0]);j(c.selection.getRng().startContainer).parent().closest('[contenteditable="true"]').focus()},!0));g.registerHandler(13,i(/(^\u200b?\|\s?(?:[^|]*\s?\|\s?)+$)/,
function(a){var b="<table class='confluenceTable'><tr>",f=!0,a=j(a[1].slice(1,-1).split("|")).map(function(a){a=j.trim(this);f=f&&""==a;return a});f&&(a[0]=k.I18n.getText("editor.autoformat.sampletext.firstcell"));for(var d=0,e=a.length;d<e;d++)b+="<td class='confluenceTd'>"+a[d]+"</td>";c.execCommand("mceInsertContent",!1,b+"</tr></table>",{skip_undo:!0});f&&c.selection.select(j(c.selection.getRng(!0).commonAncestorContainer).parents("table").find("td")[0].childNodes[0]);j(c.selection.getRng().startContainer).parent().closest('[contenteditable="true"]').focus()},
!0));d=i(/\b(((https?|ftp):\/\/|(www\.))[\w\.\$\-_\+!\*'\(\),/\?:@=&%#~;\[\]]+)$/,function(a){var b=c.dom.create("a",{href:a[3]?a[1]:"http://"+a[1]});b.appendChild(m.createTextNode(a[1]));c.execCommand("mceInsertContent",!1,n(b),{skip_undo:!0});c.getDoc().execCommand("unlink",!1,{})},!1,"a");g.registerHandler(32,d);g.registerHandler(13,d);d=i(/\b((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)$/i,
function(a){var b=c.dom.create("a",{href:"mailto:"+a[1]});b.appendChild(m.createTextNode(a[1]));c.execCommand("mceInsertContent",!1,n(b),{skip_undo:!0});c.getDoc().execCommand("unlink",!1,{})},!1,"a");g.registerHandler(32,d);g.registerHandler(13,d);d=function(a,b){var d=i(a,function(){c.execCommand("mceInsertContent",!1,b,{skip_undo:!0})},!1);g.registerHandler(32,d);g.registerHandler(13,d)};d(/(?:\b|^)([Jj]ira)$/,"JIRA");d(/(?:\b|^)(bitbucket|[Bb]itBucket)$/,"Bitbucket");d(/(?:\b|^)(atlassian)$/,
"Atlassian");d(/(?:\b|^)([Hh]ipchat)$/,"HipChat");j.each({"]":h.regularExpressions._REGEXES.WIKI_LINK,"}":h.regularExpressions._REGEXES.WIKI_MACRO,"!":h.regularExpressions._REGEXES.WIKI_EMBED},function(a,b){g.registerHandler(a.charCodeAt(0),i(b,function(b){var d=b[1]+a,b={type:"POST",contentType:"application/json; charset=utf-8",url:k.Meta.get("context-path")+"/rest/tinymce/1/wikixhtmlconverter",data:j.toJSON({wiki:d,entityId:k.Meta.get("content-id"),spaceKey:k.Meta.get("space-key"),suppressFirstParagraph:!0}),
dataType:"text",timeout:5E3};"}"==a?o.confluence.MacroUtils.insertMacro(b):"!"==a?j.ajax(b).done(function(a){!d===a?o.confluence.ImageUtils.insertImagePlaceholder(a):c.execCommand("mceInsertContent",!1,a,{skip_undo:!0})}):j.ajax(b).done(function(a){c.execCommand("mceInsertContent",!1,a,{skip_undo:!0})})},!0))});c.onKeyPress.addToTop(function(a,b){return g.executeHandlers(j.browser.msie?b.keyCode:b.which,a,b,v)});return{}}};h.regularExpressions={_REGEXES:{WIKI_MACRO:/(?:\s|^)(\{[^{^}]+)$/,WIKI_LINK:/(?:\s|^)(\[[^\[^\]]+)$/,
WIKI_EMBED:/(?:\s|^)(![^!]{5,})$/},_REGEXES_EMOTICON:{SMILE:/\B(:-?)$/,SAD:/\B(:-?)$/,CHEEKY:/\B(:-?)$/,CHEEKY_2:/\B(:-?)$/,LAUGH:/\B(:-?)$/,WINK:/\B(;-?)$/,THUMBS_UP:/\B(\(y)$/,THUMBS_DOWN:/\B(\(n)$/,INFORMATION:/\B(\(i)$/,TICK:/\B(\(\/)$/,CROSS:/\B(\(x)$/,WARNING:/\B(\(!)$/,PLUS:/\B(\(\+)$/,MINUS:/\B(\(-)$/,QUESTION:/\B(\(\?)$/,LIGHT_ON:/\B(\(on)$/,LIGHT_OFF:/\B(\(off)$/,YELLOW_STAR:/\B(\(\*)$/,YELLOW_STAR_2:/\B(\(\*y)$/,RED_STAR:/\B(\(\*r)$/,GREEN_STAR:/\B(\(\*g)$/,BLUE_STAR:/\B(\(\*b)$/,HEART:/\B(<)$/,
BROKEN_HEAR:/\B(<\/)$/}};return h});require("confluence/module-exporter").safeRequire("confluence-editor/wiki-autoformat",function(k){require("confluence/module-exporter").namespace("AJS.Rte.autoformat",k.regularExpressions);require("ajs").bind("init.rte",k)});