define("confluence-editor/editor/page-editor","ajs confluence/legacy jquery document window confluence/meta confluence/api/constants confluence-editor/editor/page-editor-message".split(" "),function(d,c,b,l,N,h,o,j){function A(){var a=h.getBoolean("shared-drafts"),e=h.get("content-type")==="page"||h.get("content-type")==="blogpost",b=d.params.pageId!=="0";return e&&(b||a)}function B(a){b("#editpageform").find("input[name='atl_token']").val(a);h.set("atl-token",a);h.set("atlassian-token",a);b("#atlassian-token").attr("content",
a)}var t=d.DarkFeatures.isEnabled("editor.ajax.save")&&!d.DarkFeatures.isEnabled("editor.ajax.save.disable")&&h.get("remote-user")!=="",m=[],n=[],p=[],C=false,k=1,u=false,q,D=function(a){c.Editor.UI.setButtonState(a,c.Editor.UI.saveButton);c.Editor.UI.setButtonState(a,c.Editor.UI.previewButton);c.Editor.UI.setButtonState(a,c.Editor.UI.cancelButton)},r=function(a){var a=a||{},e=a.messageKey||"editor-error-message",b=a.message||d.I18n.getText("editor.generic.refresh");j.handleMessage(e,{title:a.title,
type:"error",message:b},function(){a.disablePublish&&D(false)})},E=function(){return h.get("edit-mode")==="limited"},P=function(a){var e=true;j.closeMessages(["offline-before-save-error"]);for(var b=0;b<n.length;b++){n[b](a)===false&&(e=false);if(a.isImmediatePropagationStopped())break}if(!e||a.isDefaultPrevented()||a.isPropagationStopped())return false;a.preventDefault();F(a).done(v).fail(O)},O=function(a){var e=a||{};r({messageKey:e.messageKey||"offline-before-save-error",message:e.disablePublish?
d.I18n.getText("editor.generic.refresh"):d.I18n.getText("editor.offline.before.save.error"),disablePublish:e.disablePublish});a&&d.trigger("analytics",{name:"editor.save.error."+a.origin+"."+a.cause});c.Editor.UI.toggleSavebarBusy(false);c.Editor.Drafts.bindUnloadMessage()},F=function(a){var e=b.Deferred();e.resolve(a);return e.promise()},G=function(){var a=function(){u=true;b(c.Editor.getCurrentForm()).submit();d.trigger("analytics",{name:"confluence.editor.close",data:{source:"publishButton"}})},
e=c.Editor.Drafts.getDraftSavingPromise();e?e.always(a):a()},v=G;d.bind("rte-ready",function(){d.Meta.getBoolean("collaborative-content")||b('meta[name="ajs-collaborative-editor-status"]').attr("content","off");c.Editor.UI.saveButton.bind("click",P)});d.bind("editor.error.message",function(a,e){r(e)});d.bind("dismiss.editor.error.message",function(a,e){j.closeMessages([e.messageKey]);e.enablePublish&&D(true)});var Q=function(){var a;for(a=0;a<m.length;a++)c.Editor.UI.cancelButton.click(m[a]);var e=
b(c.Editor.getCurrentForm());for(a=0;a<p.length;a++)e.submit(p[a]);b.unbind("init.rte",this)},H=function(a,e,c,g){g.push(c);if(d.Rte&&d.Rte.BootstrapManager&&d.Rte.BootstrapManager.isInitComplete())a.bind(e,c);else if(!C){C=true;b.bind("init.rte",Q)}},w=function(a,e,b){var c=null;d.Rte&&(d.Rte.BootstrapManager&&d.Rte.BootstrapManager.isInitComplete())&&(c=function(a,e,b){a.unbind(e,b)});for(var h=b.pop();h;){c&&c(a,e,h);h=b.pop()}},I=function(a){if(f!==a){f&&f.clear();a.start(c.Editor.heartbeat);
f=a}},f,J=h.getNumber("heartbeat-interval")||3E4,x,K;x={start:function(a){d.debug("Changing heartbeat to the normal scheduler");K=setInterval(a,J)},clear:function(){clearInterval(K)}};var L,M=Math.max(J/5,5E3),y,z;L={start:function(a){d.debug("Changing heartbeat to the recovery scheduler");z=0;var e=function(){a();var b=M*Math.pow(2,z);y=setTimeout(e,Math.min(b,3E5));z++};y=setTimeout(e,M)},clear:function(){clearTimeout(y)}};return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_SOURCE:"source",MODE_PREVIEW:"preview",
PREVIEW_OUTPUT_TYPE:"PREVIEW",currentEditMode:null,contentHasChangedSinceLastSave:false,sourceInitialValue:false,isPublishing:function(a){typeof a!=="undefined"&&(u=a);return u},isLimitedModeEnabled:E,overrideBeforeSave:function(a){F=a},overrideSave:function(a){v=a},restoreDefaultSave:function(){v=G},getNumConcurrentEditors:function(){return k},addCancelHandler:function(a){H(c.Editor.UI.cancelButton,"click",a,m)},addSaveHandler:function(a){n.push(a)},addSubmitHandler:function(a){H(b(c.Editor.getCurrentForm()),
"submit",a,p)},removeAllCancelHandlers:function(){w(c.Editor.UI.cancelButton,"click",m)},removeAllSaveHandlers:function(){w(c.Editor.UI.saveButton,"click",n)},removeAllSubmitHandlers:function(){w(b(c.Editor.getCurrentForm()),"submit",p)},hasContentChanged:function(){return!this.inRichTextMode()&&!this.contentHasChangedSinceLastSave?false:this.editorHasContentChanged()},editorHasContentChanged:function(){if(d.Rte.getEditor()==null){d.debug("Confluence.Editor: editorHasContentChanged - No active editor present. Returning false.");
return false}return d.Rte.Content.editorHasContentChanged()},isEmpty:function(){var a=b(d.Rte.getEditor().getContent()).text();return!b.trim(a)},getResumeDraftUrl:function(){var a=[];a.push(o.CONTEXT_PATH);a.push("/pages/"+(d.params.newPage?"create":"edit")+d.params.draftType+".action");a.push("?useDraft=true");a.push("&pageId="+d.params.pageId);a.push("&contentChanged="+this.hasContentChanged());this.getCurrentForm().spaceKey&&a.push("&spaceKey="+h.get("space-key"));return a.join("")},getCurrentTitle:function(){return b("#content-title")&&
b("#content-title").val()},contentFormSubmit:function(){(E()||!c.Editor.Drafts.isSharedDraftsEnabled())&&c.Editor.Drafts.unBindUnloadMessage();b(".editable-title #content-title").prop("disabled",true);return true},metadataSyncRequired:A,heartbeat:function(){var a={dataType:"json",contentId:h.get("content-id"),draftType:h.get("content-type"),spaceKey:d.params.spaceKey,contributorsHash:h.get("contributors-hash")};q=d.safe.post(o.CONTEXT_PATH+"/json/startheartbeatactivity.action",a,function(a){if(!A()&&
a){B(a.atlToken);d.Meta.set("shared-drafts",a.editMode!=="legacy");d.trigger("rte.heartbeat",a)}else if(!a||!a.atlToken||!(a.activityResponses instanceof Array)){d.trigger("rte.heartbeat-error","Invalid server response");d.logError("Unexpected server response for heartbeat:");d.log(a)}else{h.set("contributors-hash",a.contributorsHash);d.Meta.set("shared-drafts",a.editMode!=="legacy");var i=a.activityResponses;B(a.atlToken);c.Editor.heartbeatType.normal();d.trigger("rte.heartbeat",i);k=(i.length||
0)+1;if(k>1){var g=!t?b("#other-users-span"):b("#reliable-other-users-span").length===0?b("<span id='reliable-other-users-span'></span>"):b("#reliable-other-users-span");g.empty();for(var s=0;s<k-1;++s){s>0&&g.append(", ");var f=i[s];g.append(d("a").attr("href",o.CONTEXT_PATH+"/display/~"+encodeURIComponent(f.userName)).text(f.fullName));f.lastEditMessage!=null&&g.append(" ").append(d("span").addClass("smalltext").text(f.lastEditMessage))}t&&!j.isDisplayed(["heartBeat"])&&g.html().trim()!==""&&j.handleMessage("heartBeat",
{type:"info",message:d.I18n.getText("heartbeat.page.edited.info","<span id='reliable-other-users-span'>"+g.html()+"</span>")});d.isVisible("#heartbeat-div")||d.Confluence.Analytics.publish("rte.notification.concurrent-editing",{numEditors:k,pageId:d.params.pageId,draftType:d.params.draftType})}t&&k<=1&&j.closeMessages(["heartBeat"]);d.setVisible("#heartbeat-div",k>1);b(l).trigger("resize.resizeplugin");d.trigger("editor-heartbeat",a);a=a.editMode;if(a!==h.get("edit-mode")&&!(a==="collaborative"&&
h.get("edit-mode")!=="limited")){h.set("edit-mode",a);a=a==="collaborative"?d.I18n.getText("editor.collaborative.mode.enabled"):d.I18n.getText("editor.collaborative.mode.disabled");r({messageKey:"edit-mode-transition",message:a,disablePublish:true})}}},"json").fail(function(a,b,g){(a.status>=500||a.status===0)&&c.Editor.heartbeatType.recovery();if(a.status===403||a.status===401)d.logError("Heartbeat error: Unauthorized");else{d.logError("Server error on heartbeat request:");d.log(g)}d.trigger("rte.heartbeat-error",
a)})},heartbeatType:{normal:function(){I(x)},recovery:function(){I(L)},reset:function(){f&&f.clear();f=x;f.start(c.Editor.heartbeat)},cleanup:function(){if(f){f.clear();f=null}q&&q.abort&&q.abort()}},disableFrame:function(a){b("form",a).each(function(){b(this).unbind();this.onsubmit=function(){return false}});b("a",a).each(function(){b(this).attr("target","_top").unbind()});b("input, img",a).each(function(){b(this).unbind()})},previewFrameOnload:function(a,e){var i=require("tinymce");c.Editor.setMode(c.Editor.MODE_PREVIEW);
i.activeEditor.setProgressState(false);c.Editor.disableFrame(a);b(".tipsy").remove();var g=b("#main",a)[0];if(h.get("content-type")!=="comment"&&b(g).find("#main-header").length===0){var f=b("#title-heading"),j=f.attr("class");b(g).prepend('<div id="preview-header"><div id="title-heading" class="'+j+'">'+f.html()+"</div></div>")}if(b(d.Rte.getEditor().getBody()).hasClass("resizable")){var k=b(e||"#previewArea iframe"),o=0,m=0,n,p=k.height();g&&function R(){var a=b(g).outerHeight(true);if(o!==a){a!==
k.height()&&k.height(0).height(Math.max(a,p));o=a;m=0}else m++;m<500&&(n=setTimeout(R,500))}();b(l).one("mode-changed.resize-editor",function(a,b){b!==c.Editor.MODE_PREVIEW&&n&&clearTimeout(n)})}else if(i.isIE||i.isOpera){i=b(N).height();f=b("#header-precursor").height()+b("#header").height()+b("#editor-precursor").height();j=b("#savebar-container").height();b("#preview iframe").height(i-f-j-4);b("#content.edit").height("auto")}},showRichText:function(a){var e=require("tinymce");d.setVisible("#wysiwyg",
a);b(".toolbar-group-preview").toggleClass("assistive",!a);b(".toolbar-group-edit").toggleClass("assistive",a);b("#main").toggleClass("active-richtext",a);e.isGecko&&a&&d.Rte.fixEditorFocus(c.Editor.bookmark)},showPreview:function(a){if(h.get("content-type")!=="comment"){var e=b("#content-title");if(e.hasClass("placeholded")){b("#preview-title-text").text("");b("#title-text").text("")}else{b("#preview-title-text").text(e.val());b("#title-text").text(e.val())}}d.setVisible("#preview",a);b(".toolbar-group-preview").toggleClass("assistive",
a);b(".toolbar-group-edit").toggleClass("assistive",!a);b("#main").toggleClass("active-preview",a);b("#full-height-container").length&&b("#full-height-container").toggleClass("active-preview",a)},showSource:function(a){a?this.showSourceArea():this.hideSourceArea();b("#main")[a?"addClass":"removeClass"]("active-source")},setMode:function(a){d.debug("Set mode: "+a);if(a===c.Editor.MODE_RICHTEXT){this.showRichText(true);this.showPreview(false);this.showSource(false)}else if(a===c.Editor.MODE_SOURCE){this.showSource(true);
this.showRichText(false);this.showPreview(false)}else if(a===c.Editor.MODE_PREVIEW){this.showPreview(true);this.showRichText(false);this.showSource(false);c.Editor.UI.spinner.removeClass("aui-icon-wait")}setTimeout(function(){var a=b(".toolbar-group-preview");a.height(0);a.height();a.height("auto")},1);this.currentEditMode=a;b(l).trigger("mode-changed",[a])},getContentId:function(){return c.getContentId()},addErrorMessage:function(a,e,c){var g=b("#"+a),c=c?"#all-messages":"#editor-messages";g.length?
g.empty():g=b("<div></div>").attr("id",a).appendTo(c);d.messages.error(g,{closeable:true,body:e})},changeMode:function(a,e){var i=require("tinymce");d.debug("Change mode: "+a);e=e||{};if(this.inRichTextMode()&&!d.Rte.BootstrapManager.isInitComplete()||this.currentEditMode===a)return false;var g=this.currentEditMode;d.trigger("rte-changeMode",a);if(a===c.Editor.MODE_PREVIEW){var f=d.Rte.getEditor();g===c.Editor.MODE_SOURCE&&c.Editor.transferSourceToEditor();if(i.isGecko&&g===c.Editor.MODE_RICHTEXT&&
!c.Editor.bookmark)c.Editor.bookmark=i.activeEditor.selection.getBookmark();this.currentEditMode=a;i={contentId:c.getContentId(),contentType:h.get("content-type"),spaceKey:h.get("space-key"),xHtml:f.getContent(),outputType:c.Editor.PREVIEW_OUTPUT_TYPE};d.safe.ajax({type:"POST",url:o.CONTEXT_PATH+"/pages/rendercontent.action",data:i,success:c.Editor.replysetPreviewArea,timeout:2E4,error:function(){d.trigger("rte-preview-action-selected");d.trigger("rte.preview.error",{status:0});j.closeMessages(["server-offline"]);
r({messageKey:"server-offline",message:d.I18n.getText("editor.offline.preview.error"),disablePublish:false});c.Editor.currentEditMode=g;e.errorCallback&&e.errorCallback()}})}else this.setMode(a);a===c.Editor.MODE_RICHTEXT&&b(l).trigger("resize.resizeplugin");if(g===c.Editor.MODE_PREVIEW)if(i=l.getElementById("editor-preview-iframe")){f=i.contentDocument||i.contentWindow.document;f.removeChild(f.documentElement);b(i).remove()}return false},replysetPreviewArea:function(a){var c=require("tinymce");d.trigger("rte-preview-action-selected");
b("#preview-error").remove();c.activeEditor.setProgressState(true);var c=b("#previewArea"),f=b('<iframe id="editor-preview-iframe" src="about:blank" scrolling="yes" frameborder="0"></iframe>');c.html(f);c=f[0].contentDocument||f[0].contentWindow.document;c.open();c.write(a);c.close()},inRichTextMode:function(){return this.currentEditMode===c.Editor.MODE_RICHTEXT},isNewPage:function(){return b("#createpageform, #createpagetemplate").length>0},onInit:function(){var a=require("tinymce");c.Editor.setMode(c.Editor.MODE_RICHTEXT);
a.activeEditor.onClick.add(function(){var a=c.Editor.UI.postingDatePicker;a&&a.hide()})},contentChangeHandler:function(){this.contentHasChangedSinceLastSave=true},getCurrentForm:function(){return require("tinymce").activeEditor.formElement},transferSourceToEditor:function(){var a=c.Editor;if(a.sourceInitialValue){var b=a.getSourceAreaVal();if(b!==a.sourceInitialValue){var d=require("tinymce").activeEditor;d.setContent(b);d.setDirty(b)}}a.sourceInitialValue=false},hideSourceArea:function(){b("#editor-html-source-container").addClass("hidden");
this.setToolBarInactive(false);this.transferSourceToEditor();b("#rte-button-source-mode").removeClass("active");b("#rte-button-publish").unbind("click.source-save")},showSourceArea:function(){var a=require("tinymce");b("#editor-html-source-container").removeClass("hidden");this.setSourceAreaHeight();this.setToolBarInactive(true);this.sourceInitialValue=a.activeEditor.getContent();this.setSourceAreaVal(this.sourceInitialValue);b("#rte-button-source-mode").addClass("active");b("#rte-button-publish").bind("click.source-save",
c.Editor.transferSourceToEditor)},getSourceAreaVal:function(){return b("#editor-html-source").val()},setSourceAreaVal:function(a){b("#editor-html-source").val(a)},setSourceAreaHeight:function(){var a=d.Rte.getTinyMceEditorMinHeight();d.debug("HTML source height= "+a);var c=b("#editor-html-source")[0].scrollHeight;if(c>a){a=c;d.debug("ACTUAL HEIGHT "+c)}b("#editor-html-source-container").height(a+"px")},setToolBarInactive:function(a){b("#rte-toolbar").toggleClass("disabled",a)},isVisible:function(){return b("#wysiwyg:visible").length>
0||b("#editor-html-source-container:visible").length>0||b("#preview:visible").length>0}}});require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor",function(d){var c=require("confluence/legacy"),b=require("jquery"),l=require("ajs");c.Editor=b.extend(c.Editor||{},d);l.toInit(function(){l.bind("init.rte",c.Editor.onInit)});l.Editor=c.Editor});