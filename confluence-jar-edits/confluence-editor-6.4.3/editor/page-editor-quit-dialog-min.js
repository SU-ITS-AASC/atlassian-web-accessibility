define("confluence-editor/editor/page-editor-quit-dialog","jquery confluence/templates ajs confluence/meta confluence/legacy window document confluence-editor/editor/page-editor-message confluence/api/constants underscore".split(" "),function(d,m,c,f,e,x,J,n,y,z){function A(b){b.stopPropagation();b.preventDefault();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.show-diff-clicked"});a.showDiffButton.hide();a.hideDiffButton.show();s()}function B(b){b.stopPropagation();b.preventDefault();
c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.hide-diff-clicked"});a.hideDiffButton.hide();a.showDiffButton.show();a.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium");j(k)}function C(b){l();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard"});b.stopPropagation();b.preventDefault();e.Editor.UI.setButtonsState(false,a.buttonsAll);t(f.get("content-id"))}function u(){a.editorForm.append(m.Editor.Page.hiddenInputCancel()).submit()}
function v(a){if(a){a.stopPropagation();a.preventDefault()}l();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.keep-draft-clicked",data:{contributorCount:i.length+1}});u()}function D(b){e.Editor.UI.setButtonsState(false,a.buttonsAll);o.save(b);l()}function E(b){b.stopPropagation();b.preventDefault();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.draft-status-indicator.click"});p(function(){a.closeButton.show();s()})}function F(b){b.stopPropagation();b.preventDefault();
a.dialog.hide()}function s(){a.dialogEl.removeClass("aui-dialog2-medium").addClass("aui-dialog2-xlarge");j(g.SHOW_DIFF);d.ajax({url:y.CONTEXT_PATH+"/rest/tinymce/1/content/"+f.get("page-id")+"/draft/diff",type:"GET"}).success(function(b){a.dialogContent.find(".wiki-content").html(b).children().first().hasClass("diff-context-placeholder")&&a.dialogContent.find("hr").hide()})}function j(b){if(b===g.EXIT||b===g.PUBLISH)q=(new Date).getTime()/1E3;a.dialogHeader.html(m.Editor.Page.quitDialogHeader({dialogType:b}));
a.dialogContent.html(m.Editor.Page.quitDialogContent({dialogType:b,contributors:i}));a.dialogFooter.find("."+b).show();a.dialog.show()}function G(){l();c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.dialog-closed"});a.dialogEl.removeClass("aui-dialog2-xlarge").addClass("aui-dialog2-medium");e.Editor.UI.toggleSavebarBusy(false);a.dialogFooter.find(".aui-button").hide();a.dialogContent.empty()}function l(){var a=(new Date).getTime()/1E3-q;c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog."+
k+".displayed",data:{displayTimeInSeconds:a,contentId:f.get("content-id")}});q=0}function t(b,f){var g=c.contextPath(),g=h?g+"/rest/synchrony/1.0/content/"+b+"/changes/unpublished":g+"/rest/api/content/"+b+"?status=draft";h&&n.suppressMessage("editor.synchrony.revert-page");f=f||0;d.ajax({url:g,type:"DELETE",data:{draftId:b},contentType:"application/json",dataType:"json"}).done(function(){h&&n.handleMessage("collaborative-editor-discard-error",{type:"success",close:"auto",message:c.I18n.getText("editor.discard-to-published.success.message")});
c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-success",data:{contentId:b}});u()}).fail(function(d){if(d.status===409&&f<H){c.trigger("disable-draft-save");t(b,f+1)}else{c.trigger("analyticsEvent",{name:"confluence.synchrony.editor.quit-dialog.discard-error",data:{contentId:b}});c.trigger("enable-draft-save");n.handleMessage("collaborative-editor-discard-error",{type:"error",title:h?c.I18n.getText("editor.discard-to-published.error.title"):c.I18n.getText("draft.saving.error.could.not.delete"),
message:h?c.I18n.getText("editor.discard-to-published.error.message"):d.errors||c.I18n.getText("discard.draft.unknown.error")});e.Editor.UI.setButtonsState(true,a.buttonsAll)}})}function I(a,c){c&&c.contributors&&(i=z.reject(c.contributors,function(a){return a.name===f.get("remote-user")}))}function p(a){e.Editor.Drafts.save({forceSave:h,skipErrorHandler:true,onSuccessHandler:a||d.noop})}var a={},h,w,g={EXIT:"exit",PUBLISH:"publish",SHOW_DIFF:"diff"},i=[],r=false,o={},k,q=0,H=5;return{init:function(b){if(w=
f.getBoolean("shared-drafts")&&(f.get("content-type")==="page"||f.get("content-type")==="blogpost"))if(r){o.save=b.saveHandler;a.publishButton.click(D)}else{h=!f.get("new-page");a.discardButton=d("#qed-discard-button").tooltip({gravity:"s",className:"quit-editor-dialog"});if(e.Editor.isLimitedModeEnabled()&&h){e.Editor.UI.setButtonState(false,a.discardButton);a.discardButton.removeAttr("disabled")}else a.discardButton.click(C);a.saveExitButton=d("#qed-save-exit-button").click(v);a.showDiffButton=
d("#qed-show-diff-button").click(A);a.hideDiffButton=d("#qed-hide-diff-button").click(B);a.publishButton=d("#qed-publish-button");a.closeButton=d("#qed-close-button").click(F);a.buttonsAll=[a.discardButton,a.saveExitButton,a.showDiffButton,a.hideDiffButton,a.publishButton];a.dialog=c.dialog2("#quit-editor-dialog");a.dialogEl=a.dialog.$el;a.dialogHeader=a.dialogEl.find(".aui-dialog2-header");a.dialogContent=a.dialogEl.find(".aui-dialog2-content");a.dialogFooter=a.dialogEl.find(".aui-dialog2-footer");
a.editorForm=d("#wysiwyg").closest("form");d("#pluggable-status").on("click","a",E);a.dialog.on("hide",G);c.bind("editor-heartbeat",I);r=true}},process:function(b){if(w){b.stopPropagation();b.preventDefault();d(x).one("editor-heartbeat",function(){switch(b.target.id){case e.Editor.UI.saveButton.attr("id"):case e.Editor.UI.versionCommentInput.attr("id"):e.Editor.UI.toggleSavebarBusy(true);if(i.length===0)o.save();else{p();h&&a.showDiffButton.show();j(g.PUBLISH);k=g.PUBLISH}break;case e.Editor.UI.cancelButton.attr("id"):if(e.Editor.Drafts.isDraftDirty()){p();
h&&a.showDiffButton.show();e.Editor.UI.toggleSavebarBusy(true);i.length===0?a.discardButton.html(c.I18n.getText("editor.quit-dialog.button.discard.changes.by.one")):a.discardButton.html(c.I18n.getText("editor.quit-dialog.button.discard.changes.by.many"));j(g.EXIT);k=g.EXIT}else v()}});e.Editor.heartbeat()}},_destroy:function(){r=false}}});