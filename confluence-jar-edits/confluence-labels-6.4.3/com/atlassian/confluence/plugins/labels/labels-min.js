define("confluence-labels/labels/labels",["ajs","confluence/legacy","window","document","jquery"],function(d,q,w,x,b){var m,r=function(a,e){if(!a||!e)var c=b("#dialog-label-list"),a=c.attr("entityid"),e=c.attr("entitytype");return!a||!e?b(k.labelView):b(".labels-section-content").filter(function(){return this.getAttribute("entityid")==a&&this.getAttribute("entitytype")==e}).find(k.labelView)};d.bind("init.rte-control",function(){var a=0;d.Meta.get("num-labels")?a=d.Meta.get("num-labels"):b("#createPageLabelsString").val()&&
(a=b.trim(b("#createPageLabelsString").val()).split(/\s+/).length);0!=a&&(d.Meta.set("num-labels",a),b("#rte-button-labels").trigger("updateLabel"))});var y=function(a){a=b.trim(a);if(!a)return[];var e=[],c=(new Date).getTime();b(a.split(/\s+/)).each(function(a,b){var h=b.split(":"),i,d=h[0];2===h.length&&(i=h[0],d=h[1]);e.push({name:d,prefix:i,id:c});c++});return e},k={labelView:".label-list",labelItem:".aui-label",noLabelsMessage:".no-labels-message",idAttribute:"data-label-id",labelsFormFieldId:d.Meta.get("labels-form-field-id")||
"createPageLabelsString"},z=d.contextPath(),o={base:z+"/rest/ui/1.0/",getRestEndPoint:function(a){return this.base+("attachment"==a?"attachment/":"template"==a?"template/":"space"==a?"space/":"content/")},index:z+"/labels/autocompletelabel.action?maxResults=3",validate:function(){return this.getRestEndPoint()+"labels/validate"},add:function(a,b){return this.getRestEndPoint(a)+b+"/labels"},remove:function(a,b,c){return this.getRestEndPoint(a)+b+"/label/"+c},list:function(a,b){return this.getRestEndPoint(a)+
b+"/labels"}},s=function(a){var e=b("#"+k.labelsFormFieldId);e.length&&e.val(a)},t=function(){var a=b("#"+k.labelsFormFieldId);return a.length?a.val():""},u=function(){return b(".space-administration").length},l=function(a){return"0"===a||!!x.getElementById("createpagetemplate")},A=function(a){p();a&&a.promise&&(a.always([B,C]),a.done(function(a,c){d.Meta.set("num-labels",r().first().find(k.labelItem).size());b("#rte-button-labels").trigger("updateLabel");var f=c.not(".editable");0===c.find(".aui-label").length?
f.find(".labels-edit-container").before(q.Templates.Labels.nolabels()):f.find(".no-labels-message").remove()}));return a},C=function(){b("#labels-string, #add-labels-editor-button").removeAttr("disabled aria-disabled")},B=function(){b("#labels-string").val("")},p=function(a){a=a||null;b("#label-operation-error-message").empty().toggle(!!a);d.messages.warning("#label-operation-error-message",{body:a})};b(x).on("click",".label-list.editable .aui-icon-close",function(a){a.preventDefault();a=b("#dialog-label-list");
m.removeLabel(b(this).closest("li"),a.attr("entityid"),a.attr("entitytype"))});d.toInit(function(){u()&&(m.bindAutocomplete(),b(".label-list").addClass("editable"))});d.bind("editor-heartbeat",function(a,e){if("undefined"!==typeof e.labelsHash){var c=b("#rte-button-labels");if(c.data("labelsHash")!==e.labelsHash){var f=d.Meta.get("content-type"),g=q.Editor.Drafts.isNewContent()?d.Meta.get("draft-id"):d.Meta.get("page-id");l(g)||b.ajax({url:o.list(f,g),cache:!1,success:function(a){d.Meta.set("num-labels",
a.labels.length);b("#rte-button-labels").trigger("updateLabel");m.updateDialogLabelList(a.labels)},error:function(a,b){d.logError(b)}});c.data("labelsHash",e.labelsHash)}}});return m={addLabel:function(a,e,c){if(a){b("#labels-string, #add-labels-editor-button").attr({disabled:"disabled","aria-disabled":!0});if(l(e)){var a=(t()+" "+a).split(/\s+/),f=[];b.each(a,function(a,c){-1===b.inArray(c,f)&&f.push(c)});a=f.join(" ")}var a={url:l(e)?o.validate():o.add(c,e),type:"POST",dataType:"json",contentType:"application/json",
data:JSON.stringify(y(a))},g=b.Deferred(),a=b.ajax(a);a.done(function(a){var f=b("#dialog-label-list").find(".label-list"),a=a.labels,j,v=[];b.each(a,function(a,b){b.prefix&&"global"!==b.prefix?v.push(b.prefix+":"+b.name):v.push(b.name)});j=v.join(" ");if(l()){var D=(new Date).getTime();b.each(a,function(a,b){b.id=D++})}s(j);m.updateDialogLabelList(a);j=d.Meta.get("space-key");var n=r(e,c).not(".editable");n.length&&(n.find("li.aui-label").remove(),n.find("li.labels-edit-container").before(q.Templates.Labels.dialogLabels({labels:a,
spaceKey:j})));g.resolve(a,n.add(f))});a.fail(function(a,b){var c;if("timeout"===b)c=d.I18n.getText("xhr.timeout");else try{c=JSON.parse(a.responseText).message}catch(f){c=b,d.log("Unexpected error when adding labels: "+f.message)}d.log("Failed to add labels: "+c);d.log("Failed to add labels xhr: "+a.responseText);p(c);g.reject(b)});a=g.promise()}else a=!1;return A(a)},removeLabel:function(a,e,c){var f=a,g=e,h=c;if(f){f=f.jquery?f:b(f);u()&&(g=d.Meta.get("space-key"),h="space");var i=f.attr(k.idAttribute),
j=b.Deferred();l(g)?(a=b.Deferred(),a.resolve()):(a={url:o.remove(h,g,i),type:"DELETE",dataType:"json",contentType:"application/json",data:{}},a=b.ajax(a));a.done(function(){var a=u()?b("#space-categories-list"):r(g,h),c=a.find(k.labelItem).filter("["+k.idAttribute+"='"+i+"']");c.fadeOut("normal",function(){c.remove();j.resolve(f,a)});var d=b.trim(f.find("a").text()),e=t().split(/\s+/),e=b.grep(e,function(a){return a&&a!==d});s(e.join(" "))});a.fail(function(a,b){d.log(b);p(b=="timeout"?d.I18n.getText("xhr.timeout"):
b);j.reject(b)});a=j.promise()}else a=!1;return A(a)},bindAutocomplete:function(){var a=b("#labels-string"),e=a.parents("#add-labels-form").length;a.length&&(b(w).bind("quicksearch.ajax-success",function(a,b){if("/labels/autocompletelabel.action?maxResults=3"==b.url)return m.queryTokens=b.json&&b.json.queryTokens||[],!1}),b(w).bind("quicksearch.ajax-error",function(a,b){if("/labels/autocompletelabel.action?maxResults=3"==b.url)return m.queryTokens=[],!1}),a.quicksearch("/labels/autocompletelabel.action?maxResults=3",
function(){if(!b("#labels-autocomplete-list .label-suggestion").length||""===a.val())this.hide();else if(!e)for(var c=b("#labels-autocomplete-list a.label-suggestion"),f=0,d=c.length;f<d;f++)c.get(f).href="#"},{makeParams:function(a){return{query:a,contentId:d.params.pageId||""}},dropdownPlacement:function(a){b("#labels-autocomplete-list").append(a)},ajsDropDownOptions:{selectionHandler:function(c,d){if(d.find("a.label-suggestion").length){var g=b("span",d),g=b.data(g[0],"properties"),h=a.val(),i=
[];if(e)i=h.split(/\s+/),i[i.length-1]=g.name,a.val(i.join(" "));else{for(var j=m.queryTokens,i=-1,k,l="",n=0,o=j.length;n<o;n++)l=j[n],k=h.lastIndexOf(l),k>i&&(i=k);-1!=i?(j=h.substr(0,i),(h=h.substr(i+l.length).match(/^\s+/))&&(j+=h[0]),a.val(j+g.name)):a.val(g.name)}}this.hide();c.preventDefault();a.focus()}}}))},labelsAreNotPersisted:l,routes:o,setLabelError:p,parseLabelStringToArray:y,getLabelLink:function(a,b){var c="/label/";null!==a&&(void 0!=a&&""!==a)&&(c+=a+"/");var d=encodeURI;var g=b.prefix,
h=b.name;return d(c+("global"===g||"team"===g||void 0===g||""===g||null===g?h:g+":"+h))},setLabelsInputField:s,getLabelsInputField:t}});require("confluence/module-exporter").exportModuleAsGlobal("confluence-labels/labels/labels","AJS.Labels");