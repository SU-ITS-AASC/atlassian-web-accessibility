define("confluence-quick-edit/handlers/page","jquery ajs confluence/legacy confluence/meta confluence-quick-edit/handlers/shortcut confluence/aui-overrides confluence/analytics-support window confluence/api/browser confluence-editor/editor/page-editor-message".split(" "),function(c,b,g,k,t,u,v,l,w,x){function n(){var a=c("#editPageLink");a.find(".aui-icon").css("visibility","visible");a.parent().spinStop()}function o(){var a=k.get("content-type");return k.get("collaborative-content")&&(a==="page"||
a==="blogpost")}function p(a,b,f){var d={pageId:f,blockIndex:-1,columnIndex:-1,index:-1,offset:0,hasBlock:function(){return this.blockIndex!==-1}},h=false,g=function(a,c){var f=a.offset();if(i(a)){d.index=c;d.offset=b-f.top;h=true}},i=function(a){var c=a.offset();return c.top-8<=b&&c.top+a.height()>=b};if(a.children().length===1&&a.children().first().hasClass("contentLayout2")){a.children().first().children().each(function(a){if(!d.hasBlock()&&i(c(this)))d.blockIndex=a});if(d.hasBlock()){a=a.children().first().children().eq(d.blockIndex).find(".innerCell");
a.each(function(a){if(d.columnIndex===-1){var b=c(this).children().length;if(b>0)if(b<2){if(c(this).children().first().height()>25)d.columnIndex=a}else d.columnIndex=a}});a.eq(d.columnIndex).children().each(function(a){h||g(c(this),a)})}}else a.children().each(function(a){h||g(c(this),a)});return h?d:null}function y(a){var e=require("tinymce");i.disable();u.metaToParams();if(b.DarkFeatures.isEnabled("confluence.view.edit.transition")){var f=c("#main-content"),d=c("#header"),h=c("#main-header"),d=
l.pageYOffset+d.outerHeight()+h.outerHeight();j=p(f,d,b.params.pageId);b.trigger("quick-edit.viewport.saved");var k=function(){c(e.activeEditor.getWin().document).find("body#tinymce").addClass("page-edit");c("#content").css({paddingRight:0});b.unbind("quickedit.visible",k)};b.bind("quickedit.visible",k)}f=a.$form;d=b.Meta.get("content-type")==="page"?"doeditpage":"doeditblogpost";d=b.contextPath()+"/pages/"+d+".action?pageId="+g.getContentId();c(".ia-splitter-left").remove();try{c("#main").unwrap()}catch(m){}c("#rte").removeClass("editor-default").addClass("editor-fullheight");
a.$container.children().remove();c(".editor-container").children().eq(0).unwrap();f.attr({"class":"editor aui",action:d,name:"editpageform",id:"editpageform",style:""});a.$container.append(f);a.$container.removeClass("view").addClass("edit");c("body").addClass("contenteditor edit")}function z(a){require("tinymce");c("#editor-precursor").show();c("#rte-savebar").find(".toolbar-split-left").show();if(l.history.pushState){var e=c("#editPageLink").attr("href");if(e!=l.location.pathname+l.location.search){history.pushState({quickEdit:true},
"",e);b.trigger("rte-quick-edit-push-state",e)}}else{l.location.hash="editor";b.trigger("rte-quick-edit-push-hash")}e=a.content;if(e.permissions)for(var f in e.permissions)c("#"+f).attr("value",e.permissions[f]);c("#originalVersion").val(a.content.pageVersion);b.Meta.set("page-version",a.content.pageVersion);b.Meta.set("page-title",a.content.title);c('meta[name="page-version"]').attr("content",a.content.pageVersion);c('meta[name="ajs-page-version"]').attr("content",a.content.pageVersion);c("#syncRev").val(a.content.syncRev);
b.Meta.set("conf-revision",a.content.confRev);c('meta[name="ajs-conf-revision"]').attr("content",a.content.confRev);f=a.content.atlToken;b.Meta.set("atl-token",f);c('input[name="atl_token"]').val(f);b.trigger("analyticsEvent",{name:"quick-edit-success"});c("#navigation").remove();var d=new Date,h=function(b,c){if(d&&!(c.type==="keydown"&&[91,92,93,224,33,34,37,38,39,40,16,17,18,20,112,113,114,115,116,117,118,119,120,121,122,123].indexOf(c.keyCode)>-1)){var f=new Date-d;d=null;g.Analytics.publish("confluence.editor.transition.firstkeydown",
{delay:f});a.editor.onKeyDown.remove(h);a.editor.onChange.remove(h)}};a.editor.onKeyDown.add(h);a.editor.onChange.add(h);g.debugTimeEnd("confluence.editor")}function A(a){setTimeout(function(){if(j){var b;b=c(a.getBody());b=j.hasBlock()?b.children().first().children().eq(j.blockIndex).find(".innerCell").eq(j.columnIndex).children().eq(j.index):b.children().eq(j.index);a.getWin().scrollTo(0,b.offset().top+j.offset);c("#main").css("visibility","visible")}})}function q(a){b.trigger("rte-collaborative-content-ready",
a)}function B(){var a=new c.Deferred;g.debugTime("confluence.editor.quick.fetchContent");var e=c.ajax({url:b.contextPath()+"/rest/tinymce/1/content/"+g.getContentId()+".json",cache:false});e.success(function(c){b.Meta.get("edit-mode")&&b.Meta.get("edit-mode")!==c.editMode&&a.reject("edit mode change",e);g.debugTimeEnd("confluence.editor.quick.fetchContent");o()&&q(c);b.bind("synchrony-events-bound",function h(){q(c);b.unbind("synchrony-events-bound",h)});a.resolve(c)});e.error(function(b){a.reject("error fetching content",
b)});return a}function r(a,e){if(e)switch(e.status){case 423:var f=JSON.parse(e.responseText).user;n();b.MessageHandler.flag({type:"info",title:b.I18n.getText("editor.unavailable.title"),body:b.I18n.getText("limited.mode.existing.editor.body",b.escapeHtml(f)),close:"manual"});return;case 412:n();x.handleMessage("collab.edit.user.limit.reached",{type:"warning",title:b.I18n.getText("collab.edit.user.limit.msg.title"),message:b.I18n.getText("collab.edit.user.limit.msg.body"),close:"manual"});v.publish("collab.edit.user.limit.reached",
{browserName:s.friendlyName(),browserVersion:s.version(),pageId:k.get("page-id"),editMode:"quick",numEditors:k.get("max-number-editors")});return}l.location=c("#editPageLink").attr("href")}var m,j,s=new w(l.navigator.userAgent),i={editShortcut:t.createShortcut("e","#editPageLink"),activateEventHandler:function(a){if(!a.metaKey&&!a.shiftKey&&!a.ctrlKey&&!a.altKey&&!(a.which===2||a.which===3)){a.preventDefault();if(m&&m.state()==="pending")b.debug("Editor is being activated. Ignoring handler...");else{m=
i.activateEditor();a=c("#editPageLink");a.find(".aui-icon").css("visibility","hidden");a.parent().spin({left:"10px"});a=c("#draft-status-lozenge");a.text()!==""&&b.Confluence.Analytics.publish("confluence.drafts.referrer",{referrerPage:"view",lozengeType:a.text()})}}},enable:function(){if(c("body").is(".theme-default")){var a=c("#editPageLink");a.bind("click",i.activateEventHandler);a.removeClass("full-load");i.editShortcut.bind();b.debug("QuickPageEdit enabled")}else b.debug("QuickPageEdit not enabled")},
activateEditor:function(){g.debugTime("confluence.editor");o()&&b.trigger("rte-quick-edit-init");var a=c("#content").find(".quick-comment-form"),e=function(){var a=require("tinymce").activeEditor.getWin(),d=c(a.document).find("#tinymce");if(a=p(d,a.pageYOffset,b.params.pageId))sessionStorage.viewPort=JSON.stringify(a)};return b.Confluence.QuickEdit.activateEditor({fetchContent:B(),$container:c("#content"),$form:a.length?a:c('<form method="post"></form>'),preInitialise:y,postInitialise:z,saveHandler:function(){b.DarkFeatures.isEnabled("confluence.view.edit.transition")&&
e();g.Editor.getNumConcurrentEditors()>1&&b.Confluence.Analytics.publish("rte.notification.concurrent-editing.save",{numEditors:g.Editor.getNumConcurrentEditors(),pageId:b.params.pageId,draftType:b.params.draftType})},cancelHandler:function(){b.DarkFeatures.isEnabled("confluence.view.edit.transition")&&e();g.Editor.getNumConcurrentEditors()>1&&b.Confluence.Analytics.publish("rte.notification.concurrent-editing.cancel",{numEditors:g.Editor.getNumConcurrentEditors(),pageId:b.params.pageId,draftType:b.params.draftType})},
plugins:b.Confluence.Editor._Profiles.createProfileForPageEditor({versionComment:true,notifyWatchers:true}).plugins,onInitialise:function(a){b.DarkFeatures.isEnabled("confluence.view.edit.transition")&&a.onLoad.add(A)}}).fail(r)},disable:function(){b.debug("QuickPageEdit disabled.");i.editShortcut.unbind();c("#editPageLink").unbind("click",i.activateEventHandler)}};b.Confluence.QuickEdit.register(i);return{disable:i.disable,_objForTesting:{onFailActivateEditor:r}}});
require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/handlers/page","AJS.Confluence.QuickEdit.QuickEditPage");