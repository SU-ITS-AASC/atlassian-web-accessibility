define("confluence-quick-edit/quick-edit",["ajs","confluence/legacy","confluence/templates","confluence/meta","jquery","window","document","confluence-quick-edit/util","wrm"],function(e,t,n,o,r,i,a,d,c){"use strict";var l={enableShortcut:function(){r("#editPageLink").addClass("full-load")},disableShortcut:function(){r("#editPageLink").removeClass("full-load")}};function u(t){r(".quick-comment-prompt",t.$container).hide(),r(".quick-comment-body",t.$container).addClass("comment-body");var i,a,d,c,l,u=e.Confluence.EditorLoader.getPreloadContainer();t.content&&t.content.title&&(i=u,a=t.content.title,i.find("#content-title").val(a)),t.$form.append(u.children()),u.show(),r("#editor-precursor").hide(),r("#rte-savebar").find(".toolbar-split-left").hide(),"comment"===o.get("content-type")&&(r("#pluggable-status").hide(),d=n.Editor.Page.cancelButton({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts")}),c=r("#rte-button-cancel"),(l=c.parent(".rte-toolbar-group-done")).length?(l.remove(),r("#rte-button-discard").remove()):c.remove(),r("#rte-savebar").find(".toolbar-split-right").append(d))}function s(t){t.$container.find(".quick-comment-loading-container").hide(),t.$form.show(),t.$form.addClass("fadeIn");var n,o,i,a=t.content?t.content.editorContent:"";n=t.editor,o=a,i=t.replayBufferedKeys,o&&(e.debug("Initial Editor Content from quick edit: ",o),n.setContent(o),n.startContent=n.getContent({format:"raw",no_events:1}),n.undoManager.clear()),i()&&n.undoManager.add(),e.trigger("quickedit.success"),e.trigger("quickedit.visible"),e.trigger("add-bindings.keyboardshortcuts"),e.trigger("active.dynamic.rte"),r("div.aui-message.closeable").each(function(){var t,n=r(this),o="icon-close";n.find("."+o).length||(t=r('<span class="aui-icon '+o+'" role="button" tabindex="0"></span>').click(function(){n.closeMessage()}).keypress(function(t){t.which!==e.keyCode.ENTER&&t.which!==e.keyCode.SPACE||(n.closeMessage(),t.preventDefault())}),n.append(t))})}var f=[];var g={loadingContentTimeout:4e3,register:function(e){f.push(e)},disableHandlers:function(){r.each(f,function(e,t){return t.disable()})},enableHandlers:function(){r.each(f,function(e,t){return t.enable()})},SaveBarBinder:{bind:function(e,n){e&&t.Editor.addSaveHandler(e),n&&t.Editor.addCancelHandler(n)}},activateEditor:function(t){function n(){var n,f=new r.Deferred;if(e.Rte&&e.Rte.getEditor())return e.debug("there is already an editor open"),f.reject("there is already an editor open");if(!t.$container||!t.$form)return e.logError("activateEditor could not be initialsed: bad arguments",t),f.reject("bad parameters");n=e.Confluence.BlockAndBuffer.block(r(a)),t.preActivate&&t.preActivate(),l.disableShortcut();var m=t.timeoutResources||e.Confluence.EditorLoader.loadingTimeout,p=g.loadingContentTimeout;var v,b,h,y=d.timeoutDeferred;return r.when(y("resources",(h=new r.Deferred,e.Confluence.EditorLoader.load(function(){setTimeout(function(){h.resolve()},0)},function(){h.reject()}),h),m),y("fetch content",t.fetchContent||r.Deferred().resolve(),p),y("additional resources",t.additionalResources?(v=t.additionalResources,b=new r.Deferred,c.require(v).done(function(e){b.resolve(e)}).fail(function(e){b.reject(e)}),b):r.Deferred().resolve(),m)).done(function(i,a){var d={$container:t.$container,content:a,$form:t.$form,replayBufferedKeys:n};t.preInitialise&&t.preInitialise(d),u(d);var c=function(){var n;d.editor=e.Rte.getEditor(),s(d),t.postInitialise&&t.postInitialise(d),g.SaveBarBinder.bind(t.saveHandler,t.cancelHandler),e.trigger("rte-quick-edit-ready"),n=o.get("content-type"),!o.get("collaborative-content")||"page"!==n&&"blogpost"!==n||e.trigger("rte-collab-editor-loaded"),e.unbind("rte-ready",c),f.resolve()};e.bind("rte-ready",c),e.bind("rte-destroyed",t.postDeactivate||function(){}),e.Rte.BootstrapManager.initialise({plugins:t.plugins,toolbar:t.toolbar,excludePlugins:t.excludePlugins,isQuickEdit:!0,onInitialise:t.onInitialise}),r("#rte-toolbar, #comments-section .aui-button").attr("tabindex","0")}).fail(function(n,o){f.reject(n,o),e.logError("Error loading page quick edit. Falling back to normal edit URL..."),e.trigger("analytics",{name:"rte.quick-edit.activate-editor.failed"}),t.fallbackUrl&&(e.log("This parameter is deprecated. To be removed in the next major version (5.8 or 6.0). Please use the promise returned to bind custom action if the editor fails to load instead."),i.location=t.fallbackUrl)}),f.promise()}if(t.closeAnyExistingEditor&&e.Rte&&e.Rte.getEditor()){var f=new r.Deferred;return this.deactivateEditor().done(function(){n().done(function(){f.resolve()}).fail(function(e){f.reject(e)})}).fail(function(){e.debug("Could not deactivate current editor."),f.reject("Could not deactivate current editor.")}),f.promise()}return n()},deactivateEditor:function(){require("tinymce").execCommand("mceRemoveControl",!0,"wysiwygTextarea"),t.Editor.UI.toggleSavebarBusy(!1);var n=e.Confluence.EditorLoader.getPreloadContainer().empty();return r(".editor-container").remove(),r("#editor-precursor").remove(),r("#anonymous-warning").remove(),r(".quick-comment-prompt").show(),r(".bottom-comment-panels").show(),r("#editor-notification-container").empty(),r(".action-reply-comment").removeAttr("reply-disabled"),l.enableShortcut(),t.Editor.removeAllSaveHandlers(),t.Editor.removeAllCancelHandlers(),e.Confluence.EditorLoader.getEditorPreloadMarkup().done(function(t){n.append(t),n.hide(),new e.Confluence.QuickEditCaptchaManager(n).refreshCaptcha(),e.trigger("rte-destroyed"),e.unbind("rte-destroyed")})}};return g}),require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/quick-edit","AJS.Confluence.QuickEdit");