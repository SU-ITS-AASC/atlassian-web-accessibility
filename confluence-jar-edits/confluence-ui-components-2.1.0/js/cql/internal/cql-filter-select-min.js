define("confluence-ui-components/js/cql/internal/cql-filter-select",["jquery","underscore","ajs","confluence-ui-components/js/cql/internal/cql-ajax","confluence-ui-components/js/cql/internal/cql-field-model"],function(f,c,a,e,b){var d=window.Confluence.UI.Components.CQL.FilterSelect.Templates;function g(t){var r=t.cqlContainer;var m=r.find(".cql-fields");var i=t.onSelection;if(!i){throw Error("An onSelection callback must be provided to the FilterSelect.")}var s=f(d.container());var n=s.children("button");var q=s.find(".input-wrapper");var p=s.find("input");function j(u){u.preventDefault();q.removeClass("hidden");n.hide();s.find(".select2-choice").mousedown()}n.click(j);function h(){q.addClass("hidden");n.show()}p.bind("select2-close",function(){a.debug("CQL Field selector closed");h();setTimeout(function(){a.log("Checking CQL Field selector focus");if(!f(document.activeElement).closest(".cql-filter").length){a.debug("Setting CQL Field selector focus");n.focus()}},1)});r.append(s);function o(u){if(!u.added){return}p.auiSelect2("val","");i(u.added);a.debug("CQL Field selection made");h()}function k(u){if(t.context.environment!=="search-screen"&&!a.DarkFeatures.isEnabled("cql.search.screen")){u=c.reject(u,function(w){return w.type==="date"})}u=c.reject(u,function(w){return c.contains(t.ignoredFields,w.fieldName)});function v(){if(!m[0]){throw new Error("Why no cql-container?")}var x=m.find(".cql-filter").map(function(){return f(this).data("fieldName")});var w=c.reject(u,function(y){return c.contains(x,y.fieldName)&&!c.contains(["label"],y.fieldName)});return{results:w,text:b.getLabel}}p.auiSelect2({id:"fieldName",data:v,formatResult:b.getLabel,formatSelection:b.getLabel,placeholder:a.I18n.getText("confluence-ui-components.cql-filter-select.link")}).change(o)}function l(){a.log("Couldn't fetch CQL fields - unable to initialise CQL field picker")}e.getFields().done(k).fail(l);return p}return{build:g}});