define("confluence-ui-components/js/cql/internal/cql-filter-select",["jquery","underscore","ajs","confluence-ui-components/js/cql/internal/cql-ajax","confluence-ui-components/js/cql/internal/cql-field-model"],function(e,n,t,i,c){"use strict";var l=window.Confluence.UI.Components.CQL.FilterSelect.Templates;return{build:function(o){var r=o.cqlContainer,a=r.find(".cql-fields"),d=o.onSelection;if(!d)throw Error("An onSelection callback must be provided to the FilterSelect.");var u=e(l.container()),s=u.children("button"),f=u.find(".input-wrapper"),m=u.find("input");function h(){f.addClass("hidden"),s.show()}function p(e){e.added&&(m.auiSelect2("val",""),d(e.added),t.debug("CQL Field selection made"),h())}return s.click(function(e){e.preventDefault(),f.removeClass("hidden"),s.hide(),u.find(".select2-choice").mousedown()}),m.bind("select2-close",function(){t.debug("CQL Field selector closed"),h(),setTimeout(function(){t.log("Checking CQL Field selector focus"),e(document.activeElement).closest(".cql-filter").length||(t.debug("Setting CQL Field selector focus"),s.focus())},1)}),r.append(u),i.getFields().done(function(i){"search-screen"===o.context.environment||t.DarkFeatures.isEnabled("cql.search.screen")||(i=n.reject(i,function(e){return"date"===e.type})),i=n.reject(i,function(e){return n.contains(o.ignoredFields,e.fieldName)}),m.auiSelect2({id:"fieldName",data:function(){if(!a[0])throw new Error("Why no cql-container?");var t=a.find(".cql-filter").map(function(){return e(this).data("fieldName")});return{results:n.reject(i,function(e){return n.contains(t,e.fieldName)&&!n.contains(["label"],e.fieldName)}),text:c.getLabel}},formatResult:c.getLabel,formatSelection:c.getLabel,placeholder:t.I18n.getText("confluence-ui-components.cql-filter-select.link")}).change(p)}).fail(function(){t.log("Couldn't fetch CQL fields - unable to initialise CQL field picker")}),m}}});